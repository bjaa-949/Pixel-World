<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldBox Online - Mundo Sandbox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            overflow: hidden;
            color: #fff;
        }

        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-box {
            background: rgba(44, 62, 80, 0.95);
            border: 4px solid #3498db;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
            min-width: 350px;
        }

        .login-box h1 {
            color: #3498db;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .login-box p {
            text-align: center;
            color: #95a5a6;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: #ecf0f1;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #34495e;
            color: #ecf0f1;
            font-size: 16px;
            border-radius: 5px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-family: 'Courier New', monospace;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .error-msg {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        #gameContainer {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #gameCanvas {
            display: block;
            cursor: crosshair;
            background: #87CEEB;
        }

        #topBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(44, 62, 80, 0.95);
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }

        #topBar .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #topBar .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        #topBar .stat-icon {
            font-size: 18px;
        }

        #toolbar {
            position: fixed;
            left: 10px;
            top: 70px;
            background: rgba(44, 62, 80, 0.95);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }

        .tool-btn {
            width: 50px;
            height: 50px;
            background: rgba(52, 152, 219, 0.3);
            border: 2px solid #3498db;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }

        .tool-btn:hover {
            background: rgba(52, 152, 219, 0.6);
            transform: scale(1.1);
        }

        .tool-btn.active {
            background: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
        }

        #buildMenu {
            position: fixed;
            right: 10px;
            top: 70px;
            background: rgba(44, 62, 80, 0.95);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #buildMenu h3 {
            color: #3498db;
            margin-bottom: 15px;
            text-align: center;
        }

        .build-category {
            margin-bottom: 20px;
        }

        .build-category h4 {
            color: #ecf0f1;
            margin-bottom: 10px;
            font-size: 14px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 5px;
        }

        .build-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .build-item {
            background: rgba(52, 152, 219, 0.2);
            border: 2px solid #34495e;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .build-item:hover {
            background: rgba(52, 152, 219, 0.4);
            border-color: #3498db;
            transform: scale(1.05);
        }

        .build-item.selected {
            background: #3498db;
            border-color: #2ecc71;
        }

        .build-item .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .build-item .name {
            font-size: 10px;
            color: #ecf0f1;
        }

        .build-item .cost {
            font-size: 10px;
            color: #f39c12;
            margin-top: 3px;
        }

        #characterMenu {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(44, 62, 80, 0.98);
            border: 3px solid #3498db;
            border-radius: 10px;
            padding: 30px;
            display: none;
            z-index: 2000;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #characterMenu h2 {
            color: #3498db;
            text-align: center;
            margin-bottom: 20px;
        }

        .character-preview {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            border: 3px solid #3498db;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .customization-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .custom-group {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #34495e;
        }

        .custom-group h4 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .color-input {
            width: 100%;
            height: 40px;
            cursor: pointer;
            border: 2px solid #34495e;
            border-radius: 5px;
        }

        select {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            color: #ecf0f1;
            border: 2px solid #34495e;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        #mobileControls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .joystick-area {
            width: 150px;
            height: 150px;
            position: relative;
        }

        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.7);
            border: 3px solid #3498db;
            border-radius: 50%;
            position: relative;
        }

        .joystick-stick {
            width: 60px;
            height: 60px;
            background: #3498db;
            border: 3px solid #2980b9;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            background: rgba(44, 62, 80, 0.8);
            border: 3px solid #3498db;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
        }

        .action-btn:active {
            background: rgba(52, 152, 219, 0.8);
            transform: scale(0.95);
        }

        #chatBox {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            background: rgba(44, 62, 80, 0.95);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 10px;
            z-index: 1000;
        }

        #chatMessages {
            height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .chat-message {
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .chat-message .username {
            color: #3498db;
            font-weight: bold;
        }

        #chatInput {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #34495e;
            color: #ecf0f1;
            border-radius: 5px;
            font-size: 12px;
        }

        #allianceMenu {
            position: fixed;
            right: 10px;
            bottom: 20px;
            background: rgba(44, 62, 80, 0.95);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            width: 250px;
            display: none;
            z-index: 1000;
        }

        #allianceMenu h3 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .alliance-player {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            #mobileControls {
                display: flex;
            }
            
            #toolbar {
                flex-direction: row;
                left: 50%;
                transform: translateX(-50%);
                top: auto;
                bottom: 190px;
            }
            
            #buildMenu {
                top: 60px;
                right: 10px;
                max-width: calc(100vw - 20px);
            }
            
            #chatBox {
                width: calc(100vw - 40px);
                bottom: 200px;
            }
        }

        .notification {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(46, 204, 113, 0.95);
            border: 2px solid #27ae60;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 3000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-box">
            <h1>üåç WORLDBOX ONLINE</h1>
            <p>Sandbox Multiplayer</p>
            
            <div class="input-group">
                <label>Usuario</label>
                <input type="text" id="usernameInput" placeholder="Ingresa tu usuario">
            </div>
            
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="passwordInput" placeholder="Ingresa tu contrase√±a">
            </div>
            
            <button class="btn btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="register()">Crear Cuenta</button>
            
            <div class="error-msg" id="loginError"></div>
        </div>
    </div>

    <div id="gameContainer">
        <div id="topBar">
            <div class="player-info">
                <div class="stat">
                    <span class="stat-icon">üë§</span>
                    <span id="playerName">Jugador</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">üí∞</span>
                    <span id="gold">100</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">ü™µ</span>
                    <span id="wood">50</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">ü™®</span>
                    <span id="stone">50</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">üåæ</span>
                    <span id="food">30</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">‚ö°</span>
                    <span id="mana">100</span>
                </div>
            </div>
        </div>

        <div id="toolbar">
            <div class="tool-btn active" onclick="selectTool('move')" title="Mover">üëÜ</div>
            <div class="tool-btn" onclick="selectTool('build')" title="Construir">üèóÔ∏è</div>
            <div class="tool-btn" onclick="selectTool('magic')" title="Magia">‚ú®</div>
            <div class="tool-btn" onclick="selectTool('attack')" title="Atacar">‚öîÔ∏è</div>
            <div class="tool-btn" onclick="openCharacterMenu()" title="Personaje">üë§</div>
            <div class="tool-btn" onclick="toggleAllianceMenu()" title="Alianzas">ü§ù</div>
        </div>

        <div id="buildMenu">
            <h3>üèóÔ∏è CONSTRUCCI√ìN</h3>
            
            <div class="build-category">
                <h4>Edificios</h4>
                <div class="build-items">
                    <div class="build-item" onclick="selectBuild('house')">
                        <div class="icon">üè†</div>
                        <div class="name">Casa</div>
                        <div class="cost">ü™µ20 ü™®10</div>
                    </div>
                    <div class="build-item" onclick="selectBuild('tower')">
                        <div class="icon">üóº</div>
                        <div class="name">Torre</div>
                        <div class="cost">ü™µ15 ü™®25</div>
                    </div>
                    <div class="build-item" onclick="selectBuild('wall')">
                        <div class="icon">üß±</div>
                        <div class="name">Muro</div>
                        <div class="cost">ü™®15</div>
                    </div>
                    <div class="build-item" onclick="selectBuild('farm')">
                        <div class="icon">üåæ</div>
                        <div class="name">Granja</div>
                        <div class="cost">ü™µ10</div>
                    </div>
                    <div class="build-item" onclick="selectBuild('shop')">
                        <div class="icon">üè™</div>
                        <div class="name">Tienda</div>
                        <div class="cost">ü™µ30 üí∞50</div>
                    </div>
                    <div class="build-item" onclick="selectBuild('castle')">
                        <div class="icon">üè∞</div>
                        <div class="name">Castillo</div>
                        <div class="cost">ü™µ50 ü™®100</div>
                    </div>
                </div>
            </div>

            <div class="build-category">
                <h4>Decoraci√≥n</h4>
                <div class="build-items">
                    <div class="build-item" onclick="selectBuild('tree')">
                        <div class="icon">üå≥</div>
                        <div class="name">√Årbol</div>
                        <div class="cost">Gratis</div>
                    </div>
                    <div class="build-item" onclick="selectBuild('rock')">
                        <div class="icon">ü™®</div>
                        <div class="name">Roca</div>
                        <div class="cost">Gratis</div>
                    </div>
                    <div class="build-item" onclick="selectBuild('flower')">
                        <div class="icon">üå∏</div>
                        <div class="name">Flor</div>
                        <div class="cost">Gratis</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="characterMenu">
            <h2>üë§ PERSONALIZAR PERSONAJE</h2>
            
            <canvas id="characterPreview" class="character-preview" width="200" height="200"></canvas>
            
            <div class="customization-grid">
                <div class="custom-group">
                    <h4>Piel</h4>
                    <input type="color" class="color-input" id="skinColor" value="#ffdbac" onchange="updateCharacter()">
                </div>
                
                <div class="custom-group">
                    <h4>Cabello</h4>
                    <input type="color" class="color-input" id="hairColor" value="#8B4513" onchange="updateCharacter()">
                    <select id="hairStyle" onchange="updateCharacter()">
                        <option value="short">Corto</option>
                        <option value="long">Largo</option>
                        <option value="spiky">Puntiagudo</option>
                        <option value="bald">Calvo</option>
                    </select>
                </div>
                
                <div class="custom-group">
                    <h4>Camisa</h4>
                    <input type="color" class="color-input" id="shirtColor" value="#ff0000" onchange="updateCharacter()">
                </div>
                
                <div class="custom-group">
                    <h4>Pantalones</h4>
                    <input type="color" class="color-input" id="pantsColor" value="#0000ff" onchange="updateCharacter()">
                </div>
                
                <div class="custom-group">
                    <h4>Zapatos</h4>
                    <input type="color" class="color-input" id="shoesColor" value="#8B4513" onchange="updateCharacter()">
                </div>
                
                <div class="custom-group">
                    <h4>Accesorio</h4>
                    <select id="accessory" onchange="updateCharacter()">
                        <option value="none">Ninguno</option>
                        <option value="hat">Sombrero</option>
                        <option value="crown">Corona</option>
                        <option value="helmet">Casco</option>
                    </select>
                </div>
            </div>
            
            <div class="build-category">
                <h4>Poderes M√°gicos</h4>
                <div class="build-items">
                    <div class="build-item" onclick="selectPower('fire')">
                        <div class="icon">üî•</div>
                        <div class="name">Fuego</div>
                        <div class="cost">‚ö°30</div>
                    </div>
                    <div class="build-item" onclick="selectPower('ice')">
                        <div class="icon">‚ùÑÔ∏è</div>
                        <div class="name">Hielo</div>
                        <div class="cost">‚ö°30</div>
                    </div>
                    <div class="build-item" onclick="selectPower('heal')">
                        <div class="icon">üíö</div>
                        <div class="name">Curar</div>
                        <div class="cost">‚ö°20</div>
                    </div>
                    <div class="build-item" onclick="selectPower('lightning')">
                        <div class="icon">‚ö°</div>
                        <div class="name">Rayo</div>
                        <div class="cost">‚ö°40</div>
                    </div>
                    <div class="build-item" onclick="selectPower('teleport')">
                        <div class="icon">üåÄ</div>
                        <div class="name">Teletransporte</div>
                        <div class="cost">‚ö°50</div>
                    </div>
                    <div class="build-item" onclick="selectPower('shield')">
                        <div class="icon">üõ°Ô∏è</div>
                        <div class="name">Escudo</div>
                        <div class="cost">‚ö°25</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveCharacter()">Guardar Personaje</button>
            <button class="btn btn-secondary" onclick="closeCharacterMenu()">Cerrar</button>
        </div>

        <div id="allianceMenu">
            <h3>ü§ù ALIANZAS</h3>
            <button class="btn btn-primary" style="margin-bottom: 10px;" onclick="createAlliance()">Crear Alianza</button>
            <div id="allianceList"></div>
            <button class="btn btn-secondary" onclick="toggleAllianceMenu()">Cerrar</button>
        </div>

        <div id="chatBox">
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter')sendMessage()">
        </div>

        <div id="mobileControls">
            <div class="joystick-area">
                <div class="joystick-base" id="joystickBase">
                    <div class="joystick-stick" id="joystickStick"></div>
                </div>
            </div>
            
            <div class="action-buttons">
                <div class="action-btn" ontouchstart="mobileAction('interact')">üëÜ</div>
                <div class="action-btn" ontouchstart="mobileAction('magic')">‚ú®</div>
                <div class="action-btn" ontouchstart="mobileAction('attack')">‚öîÔ∏è</div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTn_VTTMznvVJIZSjKhGOkvSOQQthNSfk",
            authDomain: "no-choques.firebaseapp.com",
            projectId: "no-choques",
            storageBucket: "no-choques.firebasestorage.app",
            messagingSenderId: "222726589609",
            appId: "1:222726589609:web:59e6dd00f28be661b0edb8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUsername = null;
        let canvas, ctx;
        let currentTool = 'move';
        let currentBuild = null;
        let selectedPowers = [];
        let worldData = {};
        let players = {};
        let buildings = [];
        let resources = [];
        let animals = [];
        let camera = { x: 0, y: 0 };
        let playerData = {
            x: 400,
            y: 400,
            vx: 0,
            vy: 0,
            gold: 100,
            wood: 50,
            stone: 50,
            food: 30,
            mana: 100,
            health: 100,
            character: {
                skinColor: '#ffdbac',
                hairColor: '#8B4513',
                hairStyle: 'short',
                shirtColor: '#ff0000',
                pantsColor: '#0000ff',
                shoesColor: '#8B4513',
                accessory: 'none'
            },
            powers: [],
            weapon: null,
            alliance: null
        };

        let keys = {};
        let mouseX = 0;
        let mouseY = 0;
        let worldX = 0;
        let worldY = 0;
        let frame = 0;
        let lastUpdate = Date.now();

        function initCanvas() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        window.register = async function() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Por favor completa todos los campos';
                return;
            }
            if (username.length < 3) {
                errorDiv.textContent = 'El usuario debe tener al menos 3 caracteres';
                return;
            }
            if (password.length < 6) {
                errorDiv.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
                return;
            }

            try {
                const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@worldbox.game`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "players", userCredential.user.uid), {
                    username: username,
                    ...playerData,
                    createdAt: new Date(),
                    online: true
                });
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Error:', error);
                errorDiv.textContent = 'Error al crear la cuenta';
            }
        };

        window.login = async function() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Por favor completa todos los campos';
                return;
            }

            try {
                const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@worldbox.game`;
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.textContent = '';
            } catch (error) {
                errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const playerDoc = await getDoc(doc(db, "players", user.uid));
                if (playerDoc.exists()) {
                    const data = playerDoc.data();
                    currentUsername = data.username;
                    playerData = { ...playerData, ...data };
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('gameContainer').style.display = 'block';
                    document.getElementById('playerName').textContent = currentUsername;
                    initCanvas();
                    initGame();
                    startGameLoop();
                    listenToPlayers();
                    await updateDoc(doc(db, "players", user.uid), { online: true });
                }
            }
        });

        function initGame() {
            generateWorld();
            updateResourceDisplay();
            setupControls();
            setupMobileControls();
        }

        function generateWorld() {
            const worldSize = 200;
            for (let x = 0; x < worldSize; x++) {
                for (let y = 0; y < worldSize; y++) {
                    const tileX = x * 32;
                    const tileY = y * 32;
                    if (!worldData[`${x},${y}`]) {
                        worldData[`${x},${y}`] = { type: 'grass', x: tileX, y: tileY };
                    }
                }
            }
            for (let i = 0; i < 300; i++) {
                const x = Math.floor(Math.random() * worldSize) * 32;
                const y = Math.floor(Math.random() * worldSize) * 32;
                resources.push({ type: 'tree', x: x, y: y, health: 100 });
            }
            for (let i = 0; i < 200; i++) {
                const x = Math.floor(Math.random() * worldSize) * 32;
                const y = Math.floor(Math.random() * worldSize) * 32;
                resources.push({ type: 'rock', x: x, y: y, health: 150 });
            }
            const animalTypes = ['sheep', 'cow', 'chicken', 'pig'];
            for (let i = 0; i < 50; i++) {
                const x = Math.floor(Math.random() * worldSize * 32);
                const y = Math.floor(Math.random() * worldSize * 32);
                animals.push({
                    type: animalTypes[Math.floor(Math.random() * animalTypes.length)],
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    frame: 0
                });
            }
        }

        function listenToPlayers() {
            const playersRef = collection(db, "players");
            const q = query(playersRef, where("online", "==", true));
            onSnapshot(q, (snapshot) => {
                players = {};
                snapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid) {
                        players[doc.id] = doc.data();
                    }
                });
            });
        }

        function startGameLoop() {
            function gameLoop() {
                const now = Date.now();
                const delta = (now - lastUpdate) / 1000;
                lastUpdate = now;
                update(delta);
                render();
                frame++;
                requestAnimationFrame(gameLoop);
            }
            gameLoop();
        }

        function update(delta) {
            const speed = 200;
            if (keys['ArrowUp'] || keys['w'] || keys['W']) playerData.vy = -speed * delta;
            else if (keys['ArrowDown'] || keys['s'] || keys['S']) playerData.vy = speed * delta;
            else playerData.vy *= 0.8;
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) playerData.vx = -speed * delta;
            else if (keys['ArrowRight'] || keys['d'] || keys['D']) playerData.vx = speed * delta;
            else playerData.vx *= 0.8;
            playerData.x += playerData.vx;
            playerData.y += playerData.vy;
            playerData.x = Math.max(0, Math.min(playerData.x, 6400 - 32));
            playerData.y = Math.max(0, Math.min(playerData.y, 6400 - 32));
            camera.x = playerData.x - canvas.width / 2;
            camera.y = playerData.y - canvas.height / 2;
            animals.forEach(animal => {
                animal.x += animal.vx;
                animal.y += animal.vy;
                animal.frame++;
                if (Math.random() < 0.02) {
                    animal.vx = (Math.random() - 0.5) * 2;
                    animal.vy = (Math.random() - 0.5) * 2;
                }
                if (animal.x < 0 || animal.x > 6400) animal.vx *= -1;
                if (animal.y < 0 || animal.y > 6400) animal.vy *= -1;
            });
            if (frame % 60 === 0 && currentUser) {
                updateDoc(doc(db, "players", currentUser.uid), {
                    x: playerData.x,
                    y: playerData.y,
                    character: playerData.character
                });
            }
        }

        function render() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#E0F6FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-camera.x, -camera.y);
            const startX = Math.floor(camera.x / 32);
            const endX = Math.ceil((camera.x + canvas.width) / 32);
            const startY = Math.floor(camera.y / 32);
            const endY = Math.ceil((camera.y + canvas.height) / 32);
            for (let x = startX; x <= endX; x++) {
                for (let y = startY; y <= endY; y++) {
                    const tile = worldData[`${x},${y}`];
                    if (tile) drawTile(tile.type, x * 32, y * 32);
                }
            }
            resources.forEach(resource => {
                if (isInView(resource.x, resource.y)) {
                    if (resource.type === 'tree') drawTree(resource.x, resource.y);
                    else if (resource.type === 'rock') drawRock(resource.x, resource.y);
                }
            });
            buildings.forEach(building => {
                if (isInView(building.x, building.y)) drawBuilding(building);
            });
            animals.forEach(animal => {
                if (isInView(animal.x, animal.y)) drawAnimal(animal);
            });
            drawPlayer(playerData.x, playerData.y, playerData.character, currentUsername, true);
            Object.values(players).forEach(player => {
                if (isInView(player.x, player.y)) {
                    drawPlayer(player.x, player.y, player.character, player.username, false);
                }
            });
            ctx.restore();
            if (currentTool === 'build' && currentBuild) drawBuildPreview();
        }

        function isInView(x, y) {
            return x >= camera.x - 100 && x <= camera.x + canvas.width + 100 &&
                   y >= camera.y - 100 && y <= camera.y + canvas.height + 100;
        }

        function drawTile(type, x, y) {
            const colors = {
                grass: ['#7ec850', '#68b03c', '#5ca030'],
                dirt: ['#a0826d', '#8b6f5c', '#7a5e4c'],
                water: ['#4a90e2', '#3a7bc8', '#2a6bb8']
            };
            const color = colors[type] || colors.grass;
            const shade = color[Math.floor((x + y) / 32) % color.length];
            ctx.fillStyle = shade;
            ctx.fillRect(x, y, 32, 32);
            if (type === 'grass' && Math.random() < 0.3) {
                ctx.fillStyle = '#6aa83c';
                ctx.fillRect(x + Math.random() * 24, y + Math.random() * 24, 4, 4);
            }
        }

        function drawTree(x, y) {
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 10, y + 16, 12, 16);
            ctx.fillStyle = '#654321';
            ctx.fillRect(x + 18, y + 16, 4, 16);
            ctx.fillStyle = '#2d5016';
            ctx.fillRect(x, y, 32, 20);
            ctx.fillStyle = '#3a6b1e';
            ctx.fillRect(x + 4, y + 2, 24, 16);
            ctx.fillStyle = '#4a8b29';
            ctx.fillRect(x + 8, y + 4, 16, 12);
            ctx.fillStyle = '#5ca030';
            ctx.fillRect(x + 10, y + 6, 4, 4);
            ctx.fillRect(x + 18, y + 8, 4, 4);
        }

        function drawRock(x, y) {
            ctx.fillStyle = '#808080';
            ctx.fillRect(x + 4, y + 8, 24, 20);
            ctx.fillStyle = '#696969';
            ctx.fillRect(x + 8, y + 4, 16, 24);
            ctx.fillStyle = '#a9a9a9';
            ctx.fillRect(x + 10, y + 6, 8, 8);
            ctx.fillStyle = '#5a5a5a';
            ctx.fillRect(x + 18, y + 12, 6, 10);
        }

        function drawAnimal(animal) {
            const colors = { sheep: '#f0f0f0', cow: '#8B4513', chicken: '#fff5e1', pig: '#ffb6c1' };
            const color = colors[animal.type] || '#ffffff';
            const walkFrame = Math.floor(animal.frame / 10) % 2;
            ctx.fillStyle = color;
            ctx.fillRect(animal.x + 4, animal.y + 4, 16, 12);
            ctx.fillRect(animal.x + 2, animal.y + 2, 8, 8);
            ctx.fillStyle = '#654321';
            if (walkFrame === 0) {
                ctx.fillRect(animal.x + 6, animal.y + 16, 3, 6);
                ctx.fillRect(animal.x + 15, animal.y + 16, 3, 6);
            } else {
                ctx.fillRect(animal.x + 6, animal.y + 18, 3, 4);
                ctx.fillRect(animal.x + 15, animal.y + 18, 3, 4);
            }
            ctx.fillStyle = '#000';
            ctx.fillRect(animal.x + 3, animal.y + 4, 2, 2);
        }

        function drawBuilding(building) {
            const x = building.x;
            const y = building.y;
            switch (building.type) {
                case 'house':
                    ctx.fillStyle = '#d2691e';
                    ctx.fillRect(x, y + 16, 48, 32);
                    ctx.fillStyle = '#8b0000';
                    ctx.fillRect(x - 4, y, 56, 20);
                    ctx.fillStyle = '#a52a2a';
                    ctx.fillRect(x, y + 4, 48, 12);
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(x + 18, y + 28, 12, 20);
                    ctx.fillStyle = '#87ceeb';
                    ctx.fillRect(x + 8, y + 24, 8, 8);
                    ctx.fillRect(x + 32, y + 24, 8, 8);
                    break;
                case 'tower':
                    ctx.fillStyle = '#696969';
                    ctx.fillRect(x + 8, y + 24, 32, 40);
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(x + 12, y, 24, 64);
                    ctx.fillStyle = '#696969';
                    ctx.fillRect(x + 12, y - 4, 6, 8);
                    ctx.fillRect(x + 22, y - 4, 6, 8);
                    ctx.fillRect(x + 32, y - 4, 6, 8);
                    break;
                case 'wall':
                    ctx.fillStyle = '#a9a9a9';
                    ctx.fillRect(x, y + 16, 32, 32);
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(x + 4, y + 20, 24, 24);
                    break;
                case 'farm':
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(x, y, 48, 48);
                    ctx.fillStyle = '#9acd32';
                    for (let i = 0; i < 4; i++) {
                        for (let j = 0; j < 4; j++) {
                            ctx.fillRect(x + i * 12 + 2, y + j * 12 + 2, 8, 8);
                        }
                    }
                    break;
                case 'shop':
                    ctx.fillStyle = '#daa520';
                    ctx.fillRect(x, y + 12, 64, 40);
                    ctx.fillStyle = '#b8860b';
                    ctx.fillRect(x - 4, y, 72, 16);
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(x + 20, y + 20, 24, 12);
                    ctx.fillStyle = '#fff';
                    ctx.font = '10px "Courier New"';
                    ctx.fillText('SHOP', x + 24, y + 29);
                    break;
                case 'castle':
                    ctx.fillStyle = '#696969';
                    ctx.fillRect(x, y, 24, 80);
                    ctx.fillRect(x + 72, y, 24, 80);
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(x + 16, y + 16, 64, 64);
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(x + 36, y + 48, 24, 32);
                    for (let i = 0; i < 4; i++) {
                        ctx.fillStyle = '#696969';
                        ctx.fillRect(x + i * 24, y - 8, 12, 12);
                    }
                    break;
            }
            if (building.owner) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(x - 10, y - 20, building.type === 'castle' ? 116 : 68, 14);
                ctx.fillStyle = '#fff';
                ctx.font = '10px "Courier New"';
                ctx.textAlign = 'center';
                ctx.fillText(building.owner, x + (building.type === 'castle' ? 48 : 24), y - 9);
                ctx.textAlign = 'left';
            }
        }

        function drawPlayer(x, y, character, name, isLocal) {
            const c = character;
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(x + 4, y + 28, 16, 4);
            ctx.fillStyle = c.shoesColor;
            ctx.fillRect(x + 4, y + 24, 6, 8);
            ctx.fillRect(x + 14, y + 24, 6, 8);
            ctx.fillStyle = c.pantsColor;
            ctx.fillRect(x + 4, y + 16, 6, 8);
            ctx.fillRect(x + 14, y + 16, 6, 8);
            ctx.fillStyle = c.shirtColor;
            ctx.fillRect(x + 2, y + 8, 20, 10);
            ctx.fillRect(x, y + 10, 2, 8);
            ctx.fillRect(x + 22, y + 10, 2, 8);
            ctx.fillStyle = c.skinColor;
            ctx.fillRect(x + 8, y + 8, 8, 4);
            ctx.fillRect(x + 6, y, 12, 10);
            ctx.fillStyle = c.hairColor;
            if (c.hairStyle === 'short') {
                ctx.fillRect(x + 6, y - 2, 12, 4);
            } else if (c.hairStyle === 'long') {
                ctx.fillRect(x + 6, y - 2, 12, 6);
                ctx.fillRect(x + 4, y + 2, 16, 4);
            } else if (c.hairStyle === 'spiky') {
                ctx.fillRect(x + 6, y - 4, 4, 4);
                ctx.fillRect(x + 10, y - 4, 4, 4);
                ctx.fillRect(x + 14, y - 4, 4, 4);
            }
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 8, y + 4, 2, 2);
            ctx.fillRect(x + 14, y + 4, 2, 2);
            if (c.accessory === 'hat') {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(x + 4, y - 4, 16, 4);
                ctx.fillRect(x + 6, y - 2, 12, 2);
            } else if (c.accessory === 'crown') {
                ctx.fillStyle = '#FFD700';
                ctx.fillRect(x + 6, y - 4, 12, 4);
                ctx.fillRect(x + 8, y - 6, 2, 2);
                ctx.fillRect(x + 11, y - 6, 2, 2);
                ctx.fillRect(x + 14, y - 6, 2, 2);
            } else if (c.accessory === 'helmet') {
                ctx.fillStyle = '#C0C0C0';
                ctx.fillRect(x + 4, y - 2, 16, 6);
                ctx.fillRect(x + 6, y + 4, 12, 4);
            }
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(x - 10, y - 16, name.length * 6 + 8, 14);
            ctx.fillStyle = isLocal ? '#3498db' : '#fff';
            ctx.font = '10px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText(name, x + 12, y - 5);
            ctx.textAlign = 'left';
        }

        function drawBuildPreview() {
            if (!currentBuild) return;
            const gridX = Math.floor((worldX) / 32) * 32;
            const gridY = Math.floor((worldY) / 32) * 32;
            ctx.save();
            ctx.translate(-camera.x, -camera.y);
            ctx.globalAlpha = 0.6;
            const tempBuilding = { type: currentBuild, x: gridX, y: gridY };
            drawBuilding(tempBuilding);
            ctx.restore();
        }

        function setupControls() {
            window.addEventListener('keydown', (e) => { keys[e.key] = true; });
            window.addEventListener('keyup', (e) => { keys[e.key] = false; });
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
                worldX = mouseX + camera.x;
                worldY = mouseY + camera.y;
            });
            canvas.addEventListener('click', handleCanvasClick);
        }

        async function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left + camera.x;
            const clickY = e.clientY - rect.top + camera.y;
            if (currentTool === 'build' && currentBuild) {
                await placeBuilding(clickX, clickY);
            } else if (currentTool === 'magic' && selectedPowers.length > 0) {
                useMagic(clickX, clickY);
            } else if (currentTool === 'attack') {
                attack(clickX, clickY);
            } else if (currentTool === 'move') {
                resources.forEach((resource, index) => {
                    const dist = Math.sqrt((clickX - resource.x) ** 2 + (clickY - resource.y) ** 2);
                    if (dist < 32) collectResource(resource, index);
                });
            }
        }

        async function placeBuilding(x, y) {
            const gridX = Math.floor(x / 32) * 32;
            const gridY = Math.floor(y / 32) * 32;
            const costs = {
                house: { wood: 20, stone: 10 },
                tower: { wood: 15, stone: 25 },
                wall: { stone: 15 },
                farm: { wood: 10 },
                shop: { wood: 30, gold: 50 },
                castle: { wood: 50, stone: 100 }
            };
            const cost = costs[currentBuild];
            if (!cost) return;
            if ((cost.wood && playerData.wood < cost.wood) ||
                (cost.stone && playerData.stone < cost.stone) ||
                (cost.gold && playerData.gold < cost.gold)) {
                showNotification('‚ùå No tienes suficientes recursos', 'error');
                return;
            }
            if (cost.wood) playerData.wood -= cost.wood;
            if (cost.stone) playerData.stone -= cost.stone;
            if (cost.gold) playerData.gold -= cost.gold;
            const building = {
                type: currentBuild,
                x: gridX,
                y: gridY,
                owner: currentUsername,
                id: Date.now()
            };
            buildings.push(building);
            updateResourceDisplay();
            showNotification(`‚úÖ ${currentBuild} construido`, 'success');
            if (currentUser) {
                await updateDoc(doc(db, "players", currentUser.uid), {
                    wood: playerData.wood,
                    stone: playerData.stone,
                    gold: playerData.gold
                });
            }
        }

        function collectResource(resource, index) {
            if (resource.type === 'tree') {
                playerData.wood += 10;
                showNotification('ü™µ +10 Madera', 'success');
            } else if (resource.type === 'rock') {
                playerData.stone += 10;
                showNotification('ü™® +10 Piedra', 'success');
            }
            resources.splice(index, 1);
            updateResourceDisplay();
        }

        function useMagic(x, y) {
            if (selectedPowers.length === 0) {
                showNotification('‚ùå No tienes poderes seleccionados', 'error');
                return;
            }
            const power = selectedPowers[0];
            const manaCosts = { fire: 30, ice: 30, heal: 20, lightning: 40, teleport: 50, shield: 25 };
            const cost = manaCosts[power];
            if (playerData.mana < cost) {
                showNotification('‚ùå No tienes suficiente man√°', 'error');
                return;
            }
            playerData.mana -= cost;
            switch(power) {
                case 'fire':
                    createMagicEffect(x, y, 'üî•', '#ff4500');
                    break;
                case 'ice':
                    createMagicEffect(x, y, '‚ùÑÔ∏è', '#00bfff');
                    break;
                case 'heal':
                    playerData.health = Math.min(100, playerData.health + 30);
                    createMagicEffect(playerData.x, playerData.y, 'üíö', '#00ff00');
                    showNotification('üíö +30 Salud', 'success');
                    break;
                case 'lightning':
                    createMagicEffect(x, y, '‚ö°', '#ffff00');
                    break;
                case 'teleport':
                    playerData.x = x;
                    playerData.y = y;
                    createMagicEffect(x, y, 'üåÄ', '#9370db');
                    showNotification('üåÄ Teletransportado', 'success');
                    break;
                case 'shield':
                    createMagicEffect(playerData.x, playerData.y, 'üõ°Ô∏è', '#1e90ff');
                    showNotification('üõ°Ô∏è Escudo activado', 'success');
                    break;
            }
            updateResourceDisplay();
        }

        function createMagicEffect(x, y, emoji, color) {
            const effect = { x: x, y: y, emoji: emoji, color: color, life: 60, startLife: 60 };
            const interval = setInterval(() => {
                effect.life--;
                if (effect.life <= 0) {
                    clearInterval(interval);
                }
            }, 16);
        }

        function attack(x, y) {
            animals.forEach((animal, index) => {
                const dist = Math.sqrt((x - animal.x) ** 2 + (y - animal.y) ** 2);
                if (dist < 32) {
                    animals.splice(index, 1);
                    playerData.food += 10;
                    showNotification('üçñ +10 Comida', 'success');
                    updateResourceDisplay();
                }
            });
        }

        function updateResourceDisplay() {
            document.getElementById('gold').textContent = playerData.gold;
            document.getElementById('wood').textContent = playerData.wood;
            document.getElementById('stone').textContent = playerData.stone;
            document.getElementById('food').textContent = playerData.food;
            document.getElementById('mana').textContent = playerData.mana;
        }

        window.selectTool = function(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (tool === 'build') {
                document.getElementById('buildMenu').style.display = 'block';
            } else {
                document.getElementById('buildMenu').style.display = 'none';
            }
        };

        window.selectBuild = function(type) {
            currentBuild = type;
            document.querySelectorAll('.build-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.build-item').classList.add('selected');
        };

        window.openCharacterMenu = function() {
            document.getElementById('characterMenu').style.display = 'block';
            loadCharacterPreview();
        };

        window.closeCharacterMenu = function() {
            document.getElementById('characterMenu').style.display = 'none';
        };

        window.updateCharacter = function() {
            playerData.character = {
                skinColor: document.getElementById('skinColor').value,
                hairColor: document.getElementById('hairColor').value,
                hairStyle: document.getElementById('hairStyle').value,
                shirtColor: document.getElementById('shirtColor').value,
                pantsColor: document.getElementById('pantsColor').value,
                shoesColor: document.getElementById('shoesColor').value,
                accessory: document.getElementById('accessory').value
            };
            loadCharacterPreview();
        };

        function loadCharacterPreview() {
            const previewCanvas = document.getElementById('characterPreview');
            const previewCtx = previewCanvas.getContext('2d');
            previewCtx.imageSmoothingEnabled = false;
            previewCtx.fillStyle = '#000';
            previewCtx.fillRect(0, 0, 200, 200);
            previewCtx.save();
            previewCtx.translate(100, 100);
            previewCtx.scale(4, 4);
            const c = playerData.character;
            const x = -12;
            const y = -16;
            previewCtx.fillStyle = 'rgba(0,0,0,0.3)';
            previewCtx.fillRect(x + 4, y + 28, 16, 4);
            previewCtx.fillStyle = c.shoesColor;
            previewCtx.fillRect(x + 4, y + 24, 6, 8);
            previewCtx.fillRect(x + 14, y + 24, 6, 8);
            previewCtx.fillStyle = c.pantsColor;
            previewCtx.fillRect(x + 4, y + 16, 6, 8);
            previewCtx.fillRect(x + 14, y + 16, 6, 8);
            previewCtx.fillStyle = c.shirtColor;
            previewCtx.fillRect(x + 2, y + 8, 20, 10);
            previewCtx.fillRect(x, y + 10, 2, 8);
            previewCtx.fillRect(x + 22, y + 10, 2, 8);
            previewCtx.fillStyle = c.skinColor;
            previewCtx.fillRect(x + 8, y + 8, 8, 4);
            previewCtx.fillRect(x + 6, y, 12, 10);
            previewCtx.fillStyle = c.hairColor;
            if (c.hairStyle === 'short') {
                previewCtx.fillRect(x + 6, y - 2, 12, 4);
            } else if (c.hairStyle === 'long') {
                previewCtx.fillRect(x + 6, y - 2, 12, 6);
                previewCtx.fillRect(x + 4, y + 2, 16, 4);
            } else if (c.hairStyle === 'spiky') {
                previewCtx.fillRect(x + 6, y - 4, 4, 4);
                previewCtx.fillRect(x + 10, y - 4, 4, 4);
                previewCtx.fillRect(x + 14, y - 4, 4, 4);
            }
            previewCtx.fillStyle = '#000';
            previewCtx.fillRect(x + 8, y + 4, 2, 2);
            previewCtx.fillRect(x + 14, y + 4, 2, 2);
            if (c.accessory === 'hat') {
                previewCtx.fillStyle = '#8B4513';
                previewCtx.fillRect(x + 4, y - 4, 16, 4);
                previewCtx.fillRect(x + 6, y - 2, 12, 2);
            } else if (c.accessory === 'crown') {
                previewCtx.fillStyle = '#FFD700';
                previewCtx.fillRect(x + 6, y - 4, 12, 4);
                previewCtx.fillRect(x + 8, y - 6, 2, 2);
                previewCtx.fillRect(x + 11, y - 6, 2, 2);
                previewCtx.fillRect(x + 14, y - 6, 2, 2);
            } else if (c.accessory === 'helmet') {
                previewCtx.fillStyle = '#C0C0C0';
                previewCtx.fillRect(x + 4, y - 2, 16, 6);
                previewCtx.fillRect(x + 6, y + 4, 12, 4);
            }
            previewCtx.restore();
        }

        window.saveCharacter = async function() {
            if (currentUser) {
                await updateDoc(doc(db, "players", currentUser.uid), {
                    character: playerData.character
                });
                showNotification('‚úÖ Personaje guardado', 'success');
                closeCharacterMenu();
            }
        };

        window.selectPower = function(power) {
            if (selectedPowers.includes(power)) {
                selectedPowers = selectedPowers.filter(p => p !== power);
                event.target.classList.remove('selected');
            } else {
                if (selectedPowers.length >= 3) {
                    showNotification('‚ùå Solo puedes tener 3 poderes activos', 'error');
                    return;
                }
                selectedPowers.push(power);
                event.target.classList.add('selected');
            }
        };

        window.toggleAllianceMenu = function() {
            const menu = document.getElementById('allianceMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            if (menu.style.display === 'block') {
                loadAllianceList();
            }
        };

        function loadAllianceList() {
            const list = document.getElementById('allianceList');
            list.innerHTML = '';
            Object.values(players).forEach(player => {
                if (player.alliance === playerData.alliance && player.alliance) {
                    const div = document.createElement('div');
                    div.className = 'alliance-player';
                    div.innerHTML = `
                        <span>üë§ ${player.username}</span>
                        <span style="color: #2ecc71;">‚óè</span>
                    `;
                    list.appendChild(div);
                }
            });
        }

        window.createAlliance = async function() {
            const allianceName = prompt('Nombre de la alianza:');
            if (allianceName && allianceName.trim()) {
                playerData.alliance = allianceName;
                if (currentUser) {
                    await updateDoc(doc(db, "players", currentUser.uid), {
                        alliance: allianceName
                    });
                }
                showNotification(`ü§ù Alianza "${allianceName}" creada`, 'success');
                loadAllianceList();
            }
        };

        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message && currentUser) {
                const chatMessage = {
                    username: currentUsername,
                    message: message,
                    timestamp: Date.now()
                };
                addChatMessage(chatMessage);
                input.value = '';
                await setDoc(doc(db, "chat", Date.now().toString()), chatMessage);
            }
        };

        function addChatMessage(data) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `<span class="username">${data.username}:</span> ${data.message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            while (messagesDiv.children.length > 50) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }
        }

        const chatRef = collection(db, "chat");
        onSnapshot(chatRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    addChatMessage(change.doc.data());
                }
            });
        });

        function setupMobileControls() {
            const joystickBase = document.getElementById('joystickBase');
            const joystickStick = document.getElementById('joystickStick');
            let joystickActive = false;
            let joystickCenter = { x: 0, y: 0 };
            
            joystickBase.addEventListener('touchstart', (e) => {
                joystickActive = true;
                const rect = joystickBase.getBoundingClientRect();
                joystickCenter = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
            });
            
            joystickBase.addEventListener('touchmove', (e) => {
                if (!joystickActive) return;
                e.preventDefault();
                const touch = e.touches[0];
                const dx = touch.clientX - joystickCenter.x;
                const dy = touch.clientY - joystickCenter.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const maxDistance = 45;
                if (distance > maxDistance) {
                    const angle = Math.atan2(dy, dx);
                    joystickStick.style.left = `${50 + Math.cos(angle) * maxDistance}%`;
                    joystickStick.style.top = `${50 + Math.sin(angle) * maxDistance}%`;
                } else {
                    joystickStick.style.left = `${50 + (dx / maxDistance) * maxDistance}%`;
                    joystickStick.style.top = `${50 + (dy / maxDistance) * maxDistance}%`;
                }
                keys['ArrowUp'] = dy < -10;
                keys['ArrowDown'] = dy > 10;
                keys['ArrowLeft'] = dx < -10;
                keys['ArrowRight'] = dx > 10;
            });
            
            joystickBase.addEventListener('touchend', () => {
                joystickActive = false;
                joystickStick.style.left = '50%';
                joystickStick.style.top = '50%';
                keys['ArrowUp'] = false;
                keys['ArrowDown'] = false;
                keys['ArrowLeft'] = false;
                keys['ArrowRight'] = false;
            });
        }

        window.mobileAction = function(action) {
            if (action === 'interact') {
                const clickEvent = new MouseEvent('click', {
                    clientX: playerData.x - camera.x + canvas.getBoundingClientRect().left,
                    clientY: playerData.y - camera.y + canvas.getBoundingClientRect().top
                });
                canvas.dispatchEvent(clickEvent);
            } else if (action === 'magic') {
                selectTool('magic');
            } else if (action === 'attack') {
                selectTool('attack');
            }
        };

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            if (type === 'error') {
                notification.style.background = 'rgba(231, 76, 60, 0.95)';
                notification.style.borderColor = '#c0392b';
            }
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        setInterval(() => {
            if (playerData.mana < 100) {
                playerData.mana = Math.min(100, playerData.mana + 1);
                updateResourceDisplay();
            }
            buildings.forEach(building => {
                if (building.type === 'shop' && building.owner === currentUsername) {
                    playerData.gold += 1;
                }
            });
            buildings.forEach(building => {
                if (building.type === 'farm' && building.owner === currentUsername) {
                    playerData.food += 1;
                }
            });
            updateResourceDisplay();
        }, 5000);

        setInterval(async () => {
            if (currentUser) {
                await updateDoc(doc(db, "players", currentUser.uid), {
                    ...playerData,
                    lastUpdate: Date.now()
                });
            }
        }, 30000);

        window.addEventListener('beforeunload', async () => {
            if (currentUser) {
                await updateDoc(doc(db, "players", currentUser.uid), {
                    online: false
                });
            }
        });

        setTimeout(() => {
            const chatQuery = query(collection(db, "chat"), orderBy("timestamp", "desc"), limit(20));
            getDocs(chatQuery).then((snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push(doc.data());
                });
                messages.reverse().forEach(msg => addChatMessage(msg));
            });
        }, 1000);

        setTimeout(async () => {
            if (currentUser) {
                const buildingsDoc = await getDoc(doc(db, "world", "buildings"));
                if (buildingsDoc.exists()) {
                    buildings = buildingsDoc.data().list || [];
                }
            }
        }, 1500);

        setInterval(async () => {
            if (currentUser && buildings.length > 0) {
                await setDoc(doc(db, "world", "buildings"), {
                    list: buildings,
                    lastUpdate: Date.now()
                });
            }
        }, 60000);

    </script>
</body>
</html>
