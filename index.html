<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minijuegos - No Choques</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #container {
            text-align: center;
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }

        /* Pantalla de login */
        #loginScreen {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            display: block;
            max-width: 400px;
            margin: 0 auto;
        }

        #loginScreen h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
        }

        #loginScreen p {
            color: #666;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .error-msg {
            color: #e53e3e;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Menu principal */
        #menuScreen {
            display: none;
        }

        .menu-header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .menu-header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .user-info {
            color: #666;
            font-size: 18px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .game-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .game-desc {
            color: #666;
            font-size: 14px;
        }

        .game-highscore {
            margin-top: 10px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 5px;
            color: #48bb78;
            font-weight: bold;
        }

        /* Pantalla de juego */
        #gameScreen {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            flex-wrap: wrap;
        }

        #gameCanvas {
            border: 4px solid white;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            background: #555;
            display: block;
            margin: 0 auto;
        }

        .game-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Ranking global */
        #rankingScreen {
            display: none;
        }

        .ranking-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .ranking-tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .ranking-tab.active {
            background: #667eea;
            color: white;
        }

        .ranking-list {
            margin-top: 20px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .ranking-item.top-1 { border-left-color: #ffd700; background: #fffef0; }
        .ranking-item.top-2 { border-left-color: #c0c0c0; background: #f8f8f8; }
        .ranking-item.top-3 { border-left-color: #cd7f32; background: #fff8f0; }

        .rank-pos {
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            font-size: 18px;
        }

        .rank-name {
            flex: 1;
            text-align: left;
            padding: 0 15px;
            font-size: 16px;
        }

        .rank-score {
            font-weight: bold;
            color: #48bb78;
            font-size: 18px;
        }

        /* Character Editor */
        #characterScreen {
            display: none;
        }

        .character-editor {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .character-preview {
            width: 200px;
            height: 300px;
            margin: 20px auto;
            background: #f7fafc;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .character-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
        }

        .option-group h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        /* Game Over */
        #gameOverScreen {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            max-width: 500px;
            margin: 0 auto;
        }

        #gameOverScreen h2 {
            color: #e53e3e;
            margin-bottom: 20px;
            font-size: 36px;
        }

        #finalScore {
            font-size: 48px;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .game-header {
                font-size: 16px;
            }
            
            #gameCanvas {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Pantalla de Login -->
        <div id="loginScreen">
            <h1>üéÆ Minijuegos</h1>
            <p>¬°Juega, compite y divi√©rtete!</p>
            
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="Nombre de usuario">
            </div>
            <div class="input-group">
                <input type="password" id="passwordInput" placeholder="Contrase√±a (m√≠n. 6 caracteres)">
            </div>
            
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="register()" style="width: 100%;">Crear Cuenta</button>
            
            <div id="loginError" class="error-msg"></div>
        </div>

        <!-- Menu Principal -->
        <div id="menuScreen">
            <div class="menu-header">
                <h1>üéÆ Minijuegos</h1>
                <div class="user-info">
                    üë§ <span id="menuUsername"></span>
                </div>
            </div>

            <div class="games-grid">
                <div class="game-card" onclick="selectGame('racing')">
                    <div class="game-icon">üèéÔ∏è</div>
                    <div class="game-title">Carrera Loca</div>
                    <div class="game-desc">Esquiva los autos y llega lo m√°s lejos posible</div>
                    <div class="game-highscore" id="racing-highscore">Mejor: 0 pts</div>
                </div>

                <div class="game-card" onclick="selectGame('aliens')">
                    <div class="game-icon">üëΩ</div>
                    <div class="game-title">Golpea Aliens</div>
                    <div class="game-desc">¬°Aplasta aliens en 60 segundos!</div>
                    <div class="game-highscore" id="aliens-highscore">Mejor: 0 pts</div>
                </div>

                <div class="game-card" onclick="selectGame('platformer')">
                    <div class="game-icon">üéØ</div>
                    <div class="game-title">Plataformas</div>
                    <div class="game-desc">Salta y esquiva obst√°culos</div>
                    <div class="game-highscore" id="platformer-highscore">Mejor: 0 pts</div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showRankingScreen()">üèÜ Rankings</button>
                <button class="btn btn-secondary" onclick="showCharacterScreen()">üë§ Personalizar</button>
                <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Pantalla de Juego -->
        <div id="gameScreen">
            <div class="game-header">
                <div>üë§ <span id="playerName"></span></div>
                <div id="gameTitle">Juego</div>
                <div>üèÜ <span id="score">0</span></div>
                <div id="timerDisplay" style="display: none;">‚è±Ô∏è <span id="timer">60</span>s</div>
            </div>
            <canvas id="gameCanvas" width="400" height="600"></canvas>
            <div class="game-controls">
                <button class="btn btn-secondary" id="startGameBtn" onclick="startGame()">Iniciar Juego</button>
                <button class="btn btn-primary" onclick="backToMenu()">‚Üê Men√∫</button>
            </div>
        </div>

        <!-- Pantalla de Game Over -->
        <div id="gameOverScreen">
            <h2>¬°Juego Terminado!</h2>
            <div>Tu puntuaci√≥n:</div>
            <div id="finalScore">0</div>
            <div id="highScoreMessage" style="color: #48bb78; font-size: 18px; margin: 10px 0;"></div>
            
            <button class="btn btn-primary" onclick="playAgain()" style="width: 100%; margin-top: 20px;">Jugar de Nuevo</button>
            <button class="btn btn-secondary" onclick="backToMenuFromGameOver()" style="width: 100%;">‚Üê Men√∫ Principal</button>
        </div>

        <!-- Pantalla de Rankings -->
        <div id="rankingScreen">
            <div class="ranking-container">
                <h2 style="color: #667eea; margin-bottom: 20px;">üèÜ Rankings Globales</h2>
                
                <div class="ranking-tabs">
                    <button class="ranking-tab active" onclick="switchRanking('racing')">üèéÔ∏è Carreras</button>
                    <button class="ranking-tab" onclick="switchRanking('aliens')">üëΩ Aliens</button>
                    <button class="ranking-tab" onclick="switchRanking('platformer')">üéØ Plataformas</button>
                </div>

                <div class="ranking-list" id="rankingList"></div>

                <button class="btn btn-primary" onclick="backToMenu()" style="width: 100%; margin-top: 20px;">‚Üê Volver al Men√∫</button>
            </div>
        </div>

        <!-- Pantalla de Personaje -->
        <div id="characterScreen">
            <div class="character-editor">
                <h2 style="color: #667eea; margin-bottom: 20px;">üë§ Personaliza tu Personaje</h2>
                
                <canvas id="characterPreview" width="200" height="300" style="border: 2px solid #e0e0e0; border-radius: 10px; display: block; margin: 0 auto;"></canvas>

                <div class="character-options">
                    <div class="option-group">
                        <h3>üëï Camisa</h3>
                        <input type="color" class="color-picker" id="shirtColor" value="#3498db" onchange="updateCharacter()">
                    </div>
                    <div class="option-group">
                        <h3>üëñ Pantal√≥n</h3>
                        <input type="color" class="color-picker" id="pantsColor" value="#2c3e50" onchange="updateCharacter()">
                    </div>
                    <div class="option-group">
                        <h3>üëû Zapatos</h3>
                        <input type="color" class="color-picker" id="shoesColor" value="#000000" onchange="updateCharacter()">
                    </div>
                    <div class="option-group">
                        <h3>üß¢ Gorra</h3>
                        <select id="hatStyle" onchange="updateCharacter()">
                            <option value="none">Sin gorra</option>
                            <option value="cap">Gorra</option>
                            <option value="beanie">Gorro</option>
                            <option value="cowboy">Vaquero</option>
                        </select>
                        <input type="color" class="color-picker" id="hatColor" value="#e74c3c" onchange="updateCharacter()">
                    </div>
                    <div class="option-group">
                        <h3>üéí Accesorio</h3>
                        <select id="accessory" onchange="updateCharacter()">
                            <option value="none">Ninguno</option>
                            <option value="backpack">Mochila</option>
                            <option value="cape">Capa</option>
                            <option value="wings">Alas</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveCharacter()" style="width: 100%; margin-top: 20px;">Guardar</button>
                <button class="btn btn-secondary" onclick="backToMenu()" style="width: 100%;">‚Üê Volver</button>
            </div>
        </div>

        <div class="loading hidden" id="loading">Cargando...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, where, setDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTn_VTTMznvVJIZSjKhGOkvSOQQthNSfk",
            authDomain: "no-choques.firebaseapp.com",
            projectId: "no-choques",
            storageBucket: "no-choques.firebasestorage.app",
            messagingSenderId: "222726589609",
            appId: "1:222726589609:web:59e6dd00f28be661b0edb8",
            measurementId: "G-B7XYP5MN52"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        let currentUser = null;
        let currentUsername = null;
        let currentGame = null;
        let gameRunning = false;
        let score = 0;
        let gameLoop;
        let userHighScores = { racing: 0, aliens: 0, platformer: 0 };
        let characterCustomization = {
            shirtColor: '#3498db',
            pantsColor: '#2c3e50',
            shoesColor: '#000000',
            hatStyle: 'none',
            hatColor: '#e74c3c',
            accessory: 'none'
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ========== AUTENTICACI√ìN ==========
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading').classList.remove('hidden');
                
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        currentUsername = data.username;
                        userHighScores = data.highScores || { racing: 0, aliens: 0, platformer: 0 };
                        characterCustomization = data.character || characterCustomization;
                    } else {
                        currentUsername = user.email.split('@')[0];
                        await setDoc(doc(db, "users", user.uid), {
                            username: currentUsername,
                            highScores: userHighScores,
                            character: characterCustomization,
                            createdAt: new Date()
                        });
                    }
                    document.getElementById('loading').classList.add('hidden');
                    showMenuScreen();
                } catch (error) {
                    console.error("Error:", error);
                    currentUsername = user.email.split('@')[0];
                    document.getElementById('loading').classList.add('hidden');
                    showMenuScreen();
                }
            } else {
                showLoginScreen();
            }
        });

        window.register = async function() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Por favor completa todos los campos';
                return;
            }

            if (username.length < 3) {
                errorDiv.textContent = 'El nombre de usuario debe tener al menos 3 caracteres';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
                return;
            }

            try {
                const usernameQuery = query(collection(db, "users"), where("username", "==", username));
                const usernameSnapshot = await getDocs(usernameQuery);
                
                if (!usernameSnapshot.empty) {
                    errorDiv.textContent = 'Este nombre de usuario ya est√° en uso';
                    return;
                }

                const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@minijuegosapp.com`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    username: username,
                    highScores: { racing: 0, aliens: 0, platformer: 0 },
                    character: characterCustomization,
                    createdAt: new Date()
                });
                
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Error:', error);
                errorDiv.textContent = 'Error al crear cuenta';
            }
        };

        window.login = async function() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Por favor completa todos los campos';
                return;
            }

            errorDiv.textContent = 'Iniciando sesi√≥n...';

            try {
                const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@minijuegosapp.com`;
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.textContent = '';
            } catch (error) {
                errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
            }
        };

        window.logout = async function() {
            await signOut(auth);
            stopGame();
        };

        // ========== PANTALLAS ==========
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('rankingScreen').style.display = 'none';
            document.getElementById('characterScreen').style.display = 'none';
        }

        function showMenuScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('menuScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('rankingScreen').style.display = 'none';
            document.getElementById('characterScreen').style.display = 'none';
            document.getElementById('menuUsername').textContent = currentUsername;
            
            // Actualizar highscores en las tarjetas
            document.getElementById('racing-highscore').textContent = `Mejor: ${userHighScores.racing} pts`;
            document.getElementById('aliens-highscore').textContent = `Mejor: ${userHighScores.aliens} pts`;
            document.getElementById('platformer-highscore').textContent = `Mejor: ${userHighScores.platformer} pts`;
        }

        function showGameScreen() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('playerName').textContent = currentUsername;
            document.getElementById('score').textContent = '0';
        }

        window.showRankingScreen = function() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('rankingScreen').style.display = 'block';
            switchRanking('racing');
        };

        window.showCharacterScreen = function() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('characterScreen').style.display = 'block';
            loadCharacterEditor();
        };

        window.backToMenu = function() {
            stopGame();
            showMenuScreen();
        };

        window.backToMenuFromGameOver = function() {
            document.getElementById('gameOverScreen').style.display = 'none';
            showMenuScreen();
        };

        // ========== SELECCI√ìN DE JUEGO ==========
        window.selectGame = function(game) {
            currentGame = game;
            showGameScreen();
            
            const titles = {
                racing: 'üèéÔ∏è Carrera Loca',
                aliens: 'üëΩ Golpea Aliens',
                platformer: 'üéØ Plataformas'
            };
            
            document.getElementById('gameTitle').textContent = titles[game];
            
            if (game === 'aliens') {
                document.getElementById('timerDisplay').style.display = 'block';
            } else {
                document.getElementById('timerDisplay').style.display = 'none';
            }
            
            drawGameIdle();
        };

        function drawGameIdle() {
            ctx.fillStyle = '#555';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Presiona "Iniciar Juego"', canvas.width/2, canvas.height/2);
        }

        // ========== JUEGO: CARRERA LOCA ==========
        let racingPlayer = { x: 175, y: 520, width: 50, height: 80, speed: 7 };
        let cars = [];
        let roadLines = [];
        let keysPressed = {};

        function initRacingGame() {
            racingPlayer = { x: 175, y: 520, width: 50, height: 80, speed: 7 };
            cars = [];
            roadLines = [];
            keysPressed = {};
            for (let i = 0; i < 6; i++) {
                roadLines.push({ y: i * 120 });
            }
        }

        function updateRacingGame() {
            // Mover con teclas mantenidas
            if (keysPressed['ArrowLeft'] && racingPlayer.x > 60) {
                racingPlayer.x -= racingPlayer.speed;
            }
            if (keysPressed['ArrowRight'] && racingPlayer.x < 290) {
                racingPlayer.x += racingPlayer.speed;
            }

            roadLines.forEach(line => {
                line.y += 4;
                if (line.y > canvas.height) line.y = -20;
            });

            if (Math.random() < 0.02) {
                const lanes = [75, 175, 275];
                const lane = lanes[Math.floor(Math.random() * lanes.length)];
                cars.push({
                    x: lane,
                    y: -100,
                    width: 50,
                    height: 80,
                    color: ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'][Math.floor(Math.random() * 4)]
                });
            }

            cars = cars.filter(car => {
                car.y += 4;
                
                if (car.y > canvas.height) {
                    score += 10;
                    document.getElementById('score').textContent = score;
                    return false;
                }

                if (checkCollision(racingPlayer, car)) {
                    endGame();
                    return false;
                }
                return true;
            });

            drawRacingGame();
        }

        function drawRacingGame() {
            ctx.fillStyle = '#555';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#fff';
            ctx.fillRect(50, 0, 5, canvas.height);
            ctx.fillRect(345, 0, 5, canvas.height);

            roadLines.forEach(line => {
                ctx.fillRect(150, line.y, 4, 80);
                ctx.fillRect(250, line.y, 4, 80);
            });

            cars.forEach(car => drawCar(car.x, car.y, car.width, car.height, car.color));
            drawCar(racingPlayer.x, racingPlayer.y, racingPlayer.width, racingPlayer.height, '#3498db');
        }

        function drawCar(x, y, width, height, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y + 10, width, height - 20);
            ctx.fillRect(x + 5, y + 20, width - 10, height - 50);
            ctx.fillStyle = '#333';
            ctx.fillRect(x + 8, y + 25, width - 16, 15);
            ctx.fillStyle = '#000';
            ctx.fillRect(x - 3, y + 15, 8, 12);
            ctx.fillRect(x + width - 5, y + 15, 8, 12);
            ctx.fillRect(x - 3, y + height - 27, 8, 12);
            ctx.fillRect(x + width - 5, y + height - 27, 8, 12);
        }

        // ========== JUEGO: GOLPEA ALIENS ==========
        let aliens = [];
        let timeLeft = 60;
        let alienTimer;

        function initAliensGame() {
            aliens = [];
            timeLeft = 60;
            document.getElementById('timer').textContent = timeLeft;
            
            alienTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function updateAliensGame() {
            if (Math.random() < 0.05) {
                const holes = [
                    {x: 60, y: 150}, {x: 200, y: 150}, {x: 340, y: 150},
                    {x: 60, y: 300}, {x: 200, y: 300}, {x: 340, y: 300},
                    {x: 60, y: 450}, {x: 200, y: 450}, {x: 340, y: 450}
                ];
                
                const availableHoles = holes.filter(hole => 
                    !aliens.some(a => a.x === hole.x && a.y === hole.y)
                );
                
                if (availableHoles.length > 0 && aliens.length < 5) {
                    const hole = availableHoles[Math.floor(Math.random() * availableHoles.length)];
                    aliens.push({
                        x: hole.x,
                        y: hole.y,
                        visible: true,
                        timer: Math.random() * 60 + 60
                    });
                }
            }

            // UFO decorativo
            if (Math.random() < 0.003) {
                aliens.push({
                    x: -50,
                    y: 50,
                    isUFO: true,
                    speed: 3
                });
            }

            aliens = aliens.filter(alien => {
                if (alien.isUFO) {
                    alien.x += alien.speed;
                    return alien.x < canvas.width + 50;
                }
                
                alien.timer--;
                if (alien.timer <= 0) {
                    return false;
                }
                return true;
            });

            drawAliensGame();
        }

        function drawAliensGame() {
            ctx.fillStyle = '#cd853f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dibujar hoyos
            const holes = [
                {x: 60, y: 150}, {x: 200, y: 150}, {x: 340, y: 150},
                {x: 60, y: 300}, {x: 200, y: 300}, {x: 340, y: 300},
                {x: 60, y: 450}, {x: 200, y: 450}, {x: 340, y: 450}
            ];
            
            holes.forEach(hole => {
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(hole.x, hole.y, 30, 0, Math.PI * 2);
                ctx.fill();
            });

            aliens.forEach(alien => {
                if (alien.isUFO) {
                    // Dibujar OVNI
                    ctx.fillStyle = '#c0c0c0';
                    ctx.beginPath();
                    ctx.ellipse(alien.x, alien.y, 40, 15, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#87ceeb';
                    ctx.beginPath();
                    ctx.arc(alien.x, alien.y - 10, 20, 0, Math.PI, true);
                    ctx.fill();
                } else {
                    // Dibujar alien
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    ctx.arc(alien.x, alien.y - 20, 25, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(alien.x - 10, alien.y - 25, 5, 0, Math.PI * 2);
                    ctx.arc(alien.x + 10, alien.y - 25, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#00ff00';
                    ctx.fillRect(alien.x - 8, alien.y - 5, 5, 8);
                    ctx.fillRect(alien.x + 3, alien.y - 5, 5, 8);
                }
            });
        }

        canvas.addEventListener('click', (e) => {
            if (currentGame !== 'aliens' || !gameRunning) return;
            
            const rect = canvas.getBoundingClientRect();
            const clickX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const clickY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            aliens = aliens.filter(alien => {
                if (alien.isUFO) return true;
                
                const dist = Math.sqrt((clickX - alien.x) ** 2 + (clickY - alien.y) ** 2);
                if (dist < 30) {
                    score += 10;
                    document.getElementById('score').textContent = score;
                    return false;
                }
                return true;
            });
        });

        // ========== JUEGO: PLATAFORMAS ==========
        let platformPlayer = {
            x: 50,
            y: 500,
            width: 40,
            height: 60,
            velocityY: 0,
            jumping: false,
            gravity: 0.5,
            jumpForce: -12
        };
        let platforms = [];
        let obstacles = [];
        let cameraX = 0;

        function initPlatformerGame() {
            platformPlayer = {
                x: 50,
                y: 500,
                width: 40,
                height: 60,
                velocityY: 0,
                jumping: false,
                gravity: 0.5,
                jumpForce: -12
            };
            platforms = [
                {x: 0, y: 570, width: 200, height: 30},
                {x: 250, y: 520, width: 150, height: 30},
                {x: 450, y: 470, width: 150, height: 30},
                {x: 650, y: 420, width: 150, height: 30},
                {x: 850, y: 370, width: 150, height: 30}
            ];
            obstacles = [];
            cameraX = 0;
            
            for (let i = 1000; i < 5000; i += 200) {
                platforms.push({
                    x: i,
                    y: Math.random() * 200 + 350,
                    width: 150,
                    height: 30
                });
                
                if (Math.random() > 0.7) {
                    obstacles.push({
                        x: i + 75,
                        y: Math.random() * 200 + 300,
                        width: 30,
                        height: 30
                    });
                }
            }
        }

        function updatePlatformerGame() {
            if (keysPressed['ArrowRight']) {
                platformPlayer.x += 5;
                cameraX += 2;
                score += 1;
                document.getElementById('score').textContent = Math.floor(score);
            }
            if (keysPressed['ArrowLeft'] && platformPlayer.x > 30) {
                platformPlayer.x -= 3;
            }
            if ((keysPressed['ArrowUp'] || keysPressed[' ']) && !platformPlayer.jumping) {
                platformPlayer.velocityY = platformPlayer.jumpForce;
                platformPlayer.jumping = true;
            }

            platformPlayer.velocityY += platformPlayer.gravity;
            platformPlayer.y += platformPlayer.velocityY;

            if (platformPlayer.y > canvas.height) {
                endGame();
                return;
            }

            let onGround = false;
            platforms.forEach(platform => {
                if (platformPlayer.velocityY >= 0 &&
                    platformPlayer.x + platformPlayer.width > platform.x &&
                    platformPlayer.x < platform.x + platform.width &&
                    platformPlayer.y + platformPlayer.height >= platform.y &&
                    platformPlayer.y + platformPlayer.height <= platform.y + 20) {
                    
                    platformPlayer.y = platform.y - platformPlayer.height;
                    platformPlayer.velocityY = 0;
                    platformPlayer.jumping = false;
                    onGround = true;
                }
            });

            obstacles.forEach(obstacle => {
                if (platformPlayer.x < obstacle.x + obstacle.width &&
                    platformPlayer.x + platformPlayer.width > obstacle.x &&
                    platformPlayer.y < obstacle.y + obstacle.height &&
                    platformPlayer.y + platformPlayer.height > obstacle.y) {
                    endGame();
                }
            });

            drawPlatformerGame();
        }

        function drawPlatformerGame() {
            ctx.fillStyle = '#87ceeb';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cameraX, 0);

            ctx.fillStyle = '#8b4513';
            platforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });

            ctx.fillStyle = '#ff0000';
            obstacles.forEach(obstacle => {
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });

            drawCustomCharacter(platformPlayer.x, platformPlayer.y, platformPlayer.width, platformPlayer.height);

            ctx.restore();
        }

        function drawCustomCharacter(x, y, w, h) {
            // Zapatos
            ctx.fillStyle = characterCustomization.shoesColor;
            ctx.fillRect(x + 5, y + h - 10, 12, 10);
            ctx.fillRect(x + w - 17, y + h - 10, 12, 10);

            // Pantal√≥n
            ctx.fillStyle = characterCustomization.pantsColor;
            ctx.fillRect(x + 5, y + h * 0.5, w - 10, h * 0.5 - 10);

            // Camisa
            ctx.fillStyle = characterCustomization.shirtColor;
            ctx.fillRect(x + 5, y + h * 0.25, w - 10, h * 0.35);

            // Cabeza
            ctx.fillStyle = '#fdbcb4';
            ctx.beginPath();
            ctx.arc(x + w/2, y + h * 0.15, w * 0.35, 0, Math.PI * 2);
            ctx.fill();

            // Gorra
            if (characterCustomization.hatStyle !== 'none') {
                ctx.fillStyle = characterCustomization.hatColor;
                if (characterCustomization.hatStyle === 'cap') {
                    ctx.fillRect(x + w * 0.2, y, w * 0.6, 8);
                    ctx.fillRect(x + w * 0.1, y + 8, w * 0.8, 5);
                } else if (characterCustomization.hatStyle === 'beanie') {
                    ctx.beginPath();
                    ctx.arc(x + w/2, y + 5, w * 0.4, Math.PI, 0);
                    ctx.fill();
                } else if (characterCustomization.hatStyle === 'cowboy') {
                    ctx.beginPath();
                    ctx.ellipse(x + w/2, y + 8, w * 0.5, 5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillRect(x + w * 0.3, y, w * 0.4, 10);
                }
            }

            // Accesorio
            if (characterCustomization.accessory === 'backpack') {
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(x + w - 8, y + h * 0.3, 8, h * 0.3);
            } else if (characterCustomization.accessory === 'cape') {
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.moveTo(x + w/2, y + h * 0.25);
                ctx.lineTo(x + w + 5, y + h * 0.4);
                ctx.lineTo(x + w + 5, y + h * 0.7);
                ctx.lineTo(x + w/2, y + h * 0.6);
                ctx.closePath();
                ctx.fill();
            } else if (characterCustomization.accessory === 'wings') {
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(x - 5, y + h * 0.4, 8, 15, -0.3, 0, Math.PI * 2);
                ctx.ellipse(x + w + 5, y + h * 0.4, 8, 15, 0.3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // ========== CONTROLES ==========
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            keysPressed[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keysPressed[e.key] = false;
        });

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // ========== CONTROL DEL JUEGO ==========
        window.startGame = function() {
            if (gameRunning) return;
            
            gameRunning = true;
            score = 0;
            document.getElementById('score').textContent = '0';
            document.getElementById('startGameBtn').style.display = 'none';
            
            if (currentGame === 'racing') {
                initRacingGame();
                gameLoop = setInterval(updateRacingGame, 1000 / 60);
            } else if (currentGame === 'aliens') {
                initAliensGame();
                gameLoop = setInterval(updateAliensGame, 1000 / 60);
            } else if (currentGame === 'platformer') {
                initPlatformerGame();
                gameLoop = setInterval(updatePlatformerGame, 1000 / 60);
            }
        };

        function stopGame() {
            gameRunning = false;
            clearInterval(gameLoop);
            clearInterval(alienTimer);
            keysPressed = {};
            document.getElementById('startGameBtn').style.display = 'inline-block';
        }

        async function endGame() {
            stopGame();
            
            const isNewHighScore = score > userHighScores[currentGame];
            
            if (isNewHighScore) {
                userHighScores[currentGame] = score;
                
                await updateDoc(doc(db, "users", currentUser.uid), {
                    [`highScores.${currentGame}`]: score
                });
                
                document.getElementById('highScoreMessage').textContent = 'üéâ ¬°Nuevo r√©cord personal!';
            } else {
                document.getElementById('highScoreMessage').textContent = '';
            }
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
        }

        window.playAgain = function() {
            document.getElementById('gameOverScreen').style.display = 'none';
            showGameScreen();
            startGame();
        };

        // ========== RANKINGS ==========
        window.switchRanking = async function(game) {
            document.querySelectorAll('.ranking-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            try {
                const q = query(collection(db, "users"), orderBy(`highScores.${game}`, "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                
                const rankingList = document.getElementById('rankingList');
                rankingList.innerHTML = '';
                
                let position = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const gameScore = data.highScores?.[game] || 0;
                    
                    if (gameScore > 0) {
                        const item = document.createElement('div');
                        item.className = `ranking-item ${position <= 3 ? 'top-' + position : ''}`;
                        item.innerHTML = `
                            <span class="rank-pos">${position}¬∞</span>
                            <span class="rank-name">${data.username}</span>
                            <span class="rank-score">${gameScore} pts</span>
                        `;
                        rankingList.appendChild(item);
                        position++;
                    }
                });
                
                if (position === 1) {
                    rankingList.innerHTML = '<p style="text-align: center; color: #999;">No hay puntuaciones a√∫n</p>';
                }
            } catch (error) {
                console.error("Error cargando ranking:", error);
            }
        };

        // ========== PERSONAJE ==========
        function loadCharacterEditor() {
            document.getElementById('shirtColor').value = characterCustomization.shirtColor;
            document.getElementById('pantsColor').value = characterCustomization.pantsColor;
            document.getElementById('shoesColor').value = characterCustomization.shoesColor;
            document.getElementById('hatStyle').value = characterCustomization.hatStyle;
            document.getElementById('hatColor').value = characterCustomization.hatColor;
            document.getElementById('accessory').value = characterCustomization.accessory;
            updateCharacter();
        }

        window.updateCharacter = function() {
            characterCustomization = {
                shirtColor: document.getElementById('shirtColor').value,
                pantsColor: document.getElementById('pantsColor').value,
                shoesColor: document.getElementById('shoesColor').value,
                hatStyle: document.getElementById('hatStyle').value,
                hatColor: document.getElementById('hatColor').value,
                accessory: document.getElementById('accessory').value
            };
            
            const previewCanvas = document.getElementById('characterPreview');
            const previewCtx = previewCanvas.getContext('2d');
            
            previewCtx.fillStyle = '#f7fafc';
            previewCtx.fillRect(0, 0, 200, 300);
            
            const centerX = 100;
            const centerY = 150;
            const scale = 2;
            
            previewCtx.save();
            previewCtx.translate(centerX - 20, centerY - 30);
            previewCtx.scale(scale, scale);
            drawCustomCharacter(0, 0, 40, 60);
            previewCtx.restore();
        };

        window.saveCharacter = async function() {
            try {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    character: characterCustomization
                });
                alert('¬°Personaje guardado!');
                backToMenu();
            } catch (error) {
                console.error("Error guardando personaje:", error);
                alert('Error al guardar');
            }
        };
    </script>
</body>
</html>
