<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Choques - Juego de Carreras</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #container {
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        /* Pantalla de login */
        #loginScreen {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            display: block;
        }

        #loginScreen h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
        }

        #loginScreen p {
            color: #666;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .error-msg {
            color: #e53e3e;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Pantalla del juego */
        #gameScreen {
            display: none;
        }

        #gameInfo {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #gameCanvas {
            border: 4px solid white;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            background: #555;
            display: block;
            margin: 0 auto;
        }

        #gameControls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        #gameControls button {
            width: auto;
            padding: 10px 20px;
        }

        /* Pantalla de Game Over */
        #gameOverScreen {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        #gameOverScreen h2 {
            color: #e53e3e;
            margin-bottom: 20px;
            font-size: 36px;
        }

        #finalScore {
            font-size: 48px;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        /* Ranking */
        #rankingTable {
            margin-top: 20px;
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        #rankingTable h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .ranking-item.top-1 { border-left-color: #ffd700; }
        .ranking-item.top-2 { border-left-color: #c0c0c0; }
        .ranking-item.top-3 { border-left-color: #cd7f32; }

        .rank-pos {
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }

        .rank-name {
            flex: 1;
            text-align: left;
            padding: 0 10px;
        }

        .rank-score {
            font-weight: bold;
            color: #48bb78;
        }

        .hidden {
            display: none !important;
        }

        /* Loading */
        .loading {
            color: white;
            font-size: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Pantalla de Login -->
        <div id="loginScreen">
            <h1>游끠 No Choques</h1>
            <p>춰Esquiva los autos y consigue el mejor puntaje!</p>
            
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="Nombre de usuario">
            </div>
            <div class="input-group">
                <input type="password" id="passwordInput" placeholder="Contrase침a (m칤n. 6 caracteres)">
            </div>
            
            <button class="btn btn-primary" onclick="login()">Iniciar Sesi칩n</button>
            <button class="btn btn-secondary" onclick="register()">Crear Cuenta</button>
            
            <div id="loginError" class="error-msg"></div>
        </div>

        <!-- Pantalla del Juego -->
        <div id="gameScreen">
            <div id="gameInfo">
                <div>游녻 <span id="playerName"></span></div>
                <div>游끥 <span id="score">0</span></div>
            </div>
            <canvas id="gameCanvas" width="400" height="600"></canvas>
            <div id="gameControls">
                <button class="btn btn-secondary" onclick="startGame()">Iniciar Juego</button>
                <button class="btn btn-primary" onclick="showRanking()">Ver Ranking</button>
                <button class="btn" style="background: #e53e3e; color: white;" onclick="logout()">Cerrar Sesi칩n</button>
            </div>
        </div>

        <!-- Pantalla de Game Over -->
        <div id="gameOverScreen">
            <h2>춰Game Over!</h2>
            <div>Tu puntuaci칩n:</div>
            <div id="finalScore">0</div>
            
            <div id="rankingTable">
                <h3>游끥 Ranking Global</h3>
                <div id="rankingList"></div>
            </div>
            
            <button class="btn btn-primary" onclick="playAgain()">Jugar de Nuevo</button>
            <button class="btn btn-secondary" onclick="logout()">Cerrar Sesi칩n</button>
        </div>

        <div class="loading hidden" id="loading">Cargando...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, where, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTn_VTTMznvVJIZSjKhGOkvSOQQthNSfk",
            authDomain: "no-choques.firebaseapp.com",
            projectId: "no-choques",
            storageBucket: "no-choques.firebasestorage.app",
            messagingSenderId: "222726589609",
            appId: "1:222726589609:web:59e6dd00f28be661b0edb8",
            measurementId: "G-B7XYP5MN52"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUsername = null;
        let gameRunning = false;
        let score = 0;
        let gameLoop;
        let isAuthReady = false;

        // Variables del juego
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const player = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 120,
            width: 50,
            height: 80,
            speed: 7,
            color: '#3498db'
        };

        let cars = [];
        let roadLines = [];
        const carSpeed = 4;
        let frameCount = 0;

        // Inicializar l칤neas de carretera
        for (let i = 0; i < 6; i++) {
            roadLines.push({ y: i * 120 });
        }

        // Detectar estado de autenticaci칩n
        onAuthStateChanged(auth, async (user) => {
            console.log("Auth state changed:", user ? "Usuario encontrado" : "No hay usuario");
            
            if (user) {
                currentUser = user;
                document.getElementById('loading').classList.remove('hidden');
                
                try {
                    // Obtener el nombre de usuario desde Firestore
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        currentUsername = userDoc.data().username;
                        console.log("Username cargado:", currentUsername);
                    } else {
                        // Si no existe el documento, usar el email como username temporalmente
                        currentUsername = user.email.split('@')[0];
                        console.log("Creando documento de usuario...");
                        // Crear el documento de usuario
                        await setDoc(doc(db, "users", user.uid), {
                            username: currentUsername,
                            createdAt: new Date()
                        });
                    }
                    document.getElementById('loading').classList.add('hidden');
                    showGameScreen();
                } catch (error) {
                    console.error("Error obteniendo usuario:", error);
                    // Si hay error, usar el email como username y continuar
                    currentUsername = user.email.split('@')[0];
                    document.getElementById('loading').classList.add('hidden');
                    showGameScreen();
                }
            } else {
                currentUser = null;
                currentUsername = null;
                console.log("Mostrando pantalla de login");
                showLoginScreen();
            }
            
            isAuthReady = true;
        });

        // Funciones de autenticaci칩n
        window.register = async function() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Por favor completa todos los campos';
                return;
            }

            if (username.length < 3) {
                errorDiv.textContent = 'El nombre de usuario debe tener al menos 3 caracteres';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'La contrase침a debe tener al menos 6 caracteres';
                return;
            }

            try {
                // Verificar si el nombre de usuario ya existe
                const usernameQuery = query(collection(db, "users"), where("username", "==", username));
                const usernameSnapshot = await getDocs(usernameQuery);
                
                if (!usernameSnapshot.empty) {
                    errorDiv.textContent = 'Este nombre de usuario ya est치 en uso';
                    return;
                }

                // Crear cuenta con un email ficticio basado en el username
                const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@nochoquesapp.com`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Guardar el nombre de usuario en Firestore
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    username: username,
                    createdAt: new Date()
                });
                
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Error completo:', error);
                errorDiv.textContent = 'Error: ' + getErrorMessage(error.code);
            }
        };

        window.login = async function() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Por favor completa todos los campos';
                return;
            }

            errorDiv.textContent = 'Iniciando sesi칩n...';

            try {
                // Construir el email basado en el username
                const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@nochoquesapp.com`;
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Error login:', error);
                errorDiv.textContent = 'Error: Usuario o contrase침a incorrectos';
            }
        };

        window.logout = async function() {
            try {
                await signOut(auth);
                stopGame();
            } catch (error) {
                console.error('Error al cerrar sesi칩n:', error);
            }
        };

        function getErrorMessage(code) {
            const errors = {
                'auth/email-already-in-use': 'Este correo ya est치 registrado',
                'auth/invalid-email': 'Correo inv치lido',
                'auth/weak-password': 'Contrase침a muy d칠bil',
                'auth/user-not-found': 'Usuario no encontrado',
                'auth/wrong-password': 'Contrase침a incorrecta',
                'auth/invalid-credential': 'Credenciales inv치lidas'
            };
            return errors[code] || 'Error desconocido';
        }

        // Pantallas
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('loading').classList.add('hidden');
        }

        function showGameScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('playerName').textContent = currentUsername;
            drawGame();
        }

        function showGameOverScreen() {
            stopGame();
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            document.getElementById('finalScore').textContent = score;
            saveScore();
            loadRanking();
        }

        // Juego
        window.startGame = function() {
            if (gameRunning) return;
            
            gameRunning = true;
            score = 0;
            cars = [];
            frameCount = 0;
            player.x = canvas.width / 2 - 25;
            
            document.getElementById('score').textContent = score;
            
            gameLoop = setInterval(updateGame, 1000 / 60);
        };

        function stopGame() {
            gameRunning = false;
            clearInterval(gameLoop);
        }

        function updateGame() {
            frameCount++;
            
            // Mover l칤neas de carretera
            roadLines.forEach(line => {
                line.y += carSpeed;
                if (line.y > canvas.height) {
                    line.y = -20;
                }
            });

            // Generar autos enemigos
            if (frameCount % 80 === 0) {
                const lanes = [75, 175, 275];
                const lane = lanes[Math.floor(Math.random() * lanes.length)];
                cars.push({
                    x: lane,
                    y: -100,
                    width: 50,
                    height: 80,
                    color: ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'][Math.floor(Math.random() * 4)]
                });
            }

            // Mover autos enemigos
            cars.forEach((car, index) => {
                car.y += carSpeed;
                
                // Eliminar autos fuera de pantalla
                if (car.y > canvas.height) {
                    cars.splice(index, 1);
                    score += 10;
                    document.getElementById('score').textContent = score;
                }

                // Detectar colisi칩n
                if (checkCollision(player, car)) {
                    showGameOverScreen();
                }
            });

            drawGame();
        }

        function drawGame() {
            // Fondo (carretera)
            ctx.fillStyle = '#555';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // L칤neas laterales
            ctx.fillStyle = '#fff';
            ctx.fillRect(50, 0, 5, canvas.height);
            ctx.fillRect(345, 0, 5, canvas.height);

            // L칤neas centrales
            ctx.fillStyle = '#fff';
            roadLines.forEach(line => {
                ctx.fillRect(150, line.y, 4, 80);
                ctx.fillRect(250, line.y, 4, 80);
            });

            // Dibujar autos enemigos
            cars.forEach(car => {
                drawCar(car.x, car.y, car.width, car.height, car.color);
            });

            // Dibujar jugador
            drawCar(player.x, player.y, player.width, player.height, player.color);
        }

        function drawCar(x, y, width, height, color) {
            // Cuerpo del auto
            ctx.fillStyle = color;
            ctx.fillRect(x, y + 10, width, height - 20);
            
            // Techo
            ctx.fillRect(x + 5, y + 20, width - 10, height - 50);
            
            // Ventanas
            ctx.fillStyle = '#333';
            ctx.fillRect(x + 8, y + 25, width - 16, 15);
            
            // Ruedas
            ctx.fillStyle = '#000';
            ctx.fillRect(x - 3, y + 15, 8, 12);
            ctx.fillRect(x + width - 5, y + 15, 8, 12);
            ctx.fillRect(x - 3, y + height - 27, 8, 12);
            ctx.fillRect(x + width - 5, y + height - 27, 8, 12);
        }

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // Controles del jugador
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            if (e.key === 'ArrowLeft' && player.x > 60) {
                player.x -= player.speed;
            }
            if (e.key === 'ArrowRight' && player.x < 290) {
                player.x += player.speed;
            }
        });

        // Controles t치ctiles
        let touchStartX = 0;
        canvas.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!gameRunning) return;
            e.preventDefault();
            
            const touchX = e.touches[0].clientX;
            const diff = touchX - touchStartX;
            
            if (diff < -10 && player.x > 60) {
                player.x -= player.speed;
            }
            if (diff > 10 && player.x < 290) {
                player.x += player.speed;
            }
            
            touchStartX = touchX;
        });

        // Firebase - Guardar puntuaci칩n
        async function saveScore() {
            try {
                await addDoc(collection(db, "scores"), {
                    userId: currentUser.uid,
                    username: currentUsername,
                    score: score,
                    timestamp: new Date()
                });
            } catch (error) {
                console.error("Error guardando puntuaci칩n:", error);
            }
        }

        // Firebase - Cargar ranking
        async function loadRanking() {
            try {
                const q = query(
                    collection(db, "scores"),
                    orderBy("score", "desc"),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(q);
                const rankingList = document.getElementById('rankingList');
                rankingList.innerHTML = '';
                
                let position = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = `ranking-item ${position <= 3 ? 'top-' + position : ''}`;
                    item.innerHTML = `
                        <span class="rank-pos">${position}춿</span>
                        <span class="rank-name">${data.username}</span>
                        <span class="rank-score">${data.score} pts</span>
                    `;
                    rankingList.appendChild(item);
                    position++;
                });
            } catch (error) {
                console.error("Error cargando ranking:", error);
            }
        }

        window.showRanking = function() {
            showGameOverScreen();
        };

        window.playAgain = function() {
            showGameScreen();
            startGame();
        };
    </script>
</body>
</html>
