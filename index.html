<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minijuegos Pixel Art</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #container {
            text-align: center;
            width: 100%;
            max-width: 900px;
            padding: 20px;
        }

        #loginScreen {
            background: #16213e;
            padding: 40px;
            border-radius: 0;
            border: 4px solid #0f3460;
            max-width: 400px;
            margin: 0 auto;
        }

        #loginScreen h1 {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 32px;
            text-shadow: 2px 2px #003300;
        }

        #loginScreen p {
            color: #00cc00;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 3px solid #0f3460;
            background: #0a0e27;
            color: #00ff00;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .input-group input::placeholder {
            color: #00aa00;
        }

        .btn {
            padding: 12px 20px;
            border: 3px solid;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #0f3460;
            color: #00ff00;
            border-color: #00ff00;
        }

        .btn-secondary {
            background: #16213e;
            color: #00ffff;
            border-color: #00ffff;
        }

        .btn-danger {
            background: #16213e;
            color: #ff0000;
            border-color: #ff0000;
        }

        .error-msg {
            color: #ff0000;
            margin-top: 10px;
            font-size: 14px;
        }

        #menuScreen {
            display: none;
        }

        .menu-header {
            background: #16213e;
            padding: 20px;
            border: 4px solid #0f3460;
            margin-bottom: 20px;
        }

        .menu-header h1 {
            color: #00ff00;
            margin-bottom: 10px;
            text-shadow: 3px 3px #003300;
        }

        .user-info {
            color: #00ffff;
            font-size: 18px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-card {
            background: #16213e;
            padding: 30px;
            border: 4px solid #0f3460;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .game-card:hover {
            transform: scale(1.05);
            border-color: #00ff00;
        }

        .game-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 24px;
            color: #00ff00;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 2px 2px #003300;
        }

        .game-desc {
            color: #00aaaa;
            font-size: 14px;
        }

        .game-highscore {
            margin-top: 10px;
            padding: 8px;
            background: #0a0e27;
            color: #ffff00;
            font-weight: bold;
            border: 2px solid #0f3460;
        }

        #gameScreen {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: #00ff00;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px #003300;
            flex-wrap: wrap;
            background: #16213e;
            padding: 10px;
            border: 3px solid #0f3460;
        }

        #gameCanvas {
            border: 4px solid #00ff00;
            background: #000;
            display: block;
            margin: 0 auto;
            image-rendering: pixelated;
        }

        .game-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mobile-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .mobile-controls .btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            background: #0f3460;
            color: #00ff00;
            border-color: #00ff00;
        }

        #rankingScreen {
            display: none;
        }

        .ranking-container {
            background: #16213e;
            padding: 30px;
            border: 4px solid #0f3460;
            max-height: 80vh;
            overflow-y: auto;
        }

        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .ranking-tab {
            padding: 10px 20px;
            background: #0a0e27;
            border: 3px solid #0f3460;
            cursor: pointer;
            font-weight: bold;
            color: #00aaaa;
            font-family: 'Courier New', monospace;
        }

        .ranking-tab.active {
            background: #0f3460;
            color: #00ff00;
            border-color: #00ff00;
        }

        .ranking-list {
            margin-top: 20px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: #0a0e27;
            border: 2px solid #0f3460;
        }

        .ranking-item.top-1 { border-color: #ffd700; background: #1a1a00; }
        .ranking-item.top-2 { border-color: #c0c0c0; background: #1a1a1a; }
        .ranking-item.top-3 { border-color: #cd7f32; background: #1a0f00; }

        .rank-pos {
            font-weight: bold;
            color: #00ff00;
            min-width: 40px;
            font-size: 18px;
        }

        .rank-name {
            flex: 1;
            text-align: left;
            padding: 0 15px;
            font-size: 16px;
            color: #00ffff;
        }

        .rank-score {
            font-weight: bold;
            color: #ffff00;
            font-size: 18px;
        }

        #characterScreen {
            display: none;
        }

        .character-editor {
            background: #16213e;
            padding: 30px;
            border: 4px solid #0f3460;
        }

        .character-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option-group {
            background: #0a0e27;
            padding: 15px;
            border: 2px solid #0f3460;
        }

        .option-group h3 {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: 2px solid #0f3460;
            cursor: pointer;
            background: #000;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 2px solid #0f3460;
            font-size: 14px;
            background: #0a0e27;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .hidden {
            display: none !important;
        }

        #gameOverScreen {
            display: none;
            background: #16213e;
            padding: 40px;
            border: 4px solid #ff0000;
            max-width: 500px;
            margin: 0 auto;
        }

        #gameOverScreen h2 {
            color: #ff0000;
            margin-bottom: 20px;
            font-size: 36px;
            text-shadow: 3px 3px #330000;
        }

        #finalScore {
            font-size: 48px;
            color: #ffff00;
            margin: 20px 0;
            font-weight: bold;
            text-shadow: 3px 3px #333300;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loginScreen">
            <h1>üëæ MINIJUEGOS</h1>
            <p>RETRO PIXEL ART</p>
            
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="USUARIO">
            </div>
            <div class="input-group">
                <input type="password" id="passwordInput" placeholder="CONTRASE√ëA">
            </div>
            
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">INICIAR</button>
            <button class="btn btn-secondary" onclick="register()" style="width: 100%;">CREAR CUENTA</button>
            
            <div id="loginError" class="error-msg"></div>
        </div>

        <div id="menuScreen">
            <div class="menu-header">
                <h1>üëæ MINIJUEGOS RETRO</h1>
                <div class="user-info">
                    JUGADOR: <span id="menuUsername"></span>
                </div>
            </div>

            <div class="games-grid">
                <div class="game-card" onclick="selectGame('racing')">
                    <div class="game-icon">üèéÔ∏è</div>
                    <div class="game-title">CARRERA</div>
                    <div class="game-desc">Esquiva los autos enemigos</div>
                    <div class="game-highscore" id="racing-highscore">RECORD: 0</div>
                </div>

                <div class="game-card" onclick="selectGame('aliens')">
                    <div class="game-icon">üëæ</div>
                    <div class="game-title">ALIENS</div>
                    <div class="game-desc">Aplasta aliens en 60 segundos</div>
                    <div class="game-highscore" id="aliens-highscore">RECORD: 0</div>
                </div>

                <div class="game-card" onclick="selectGame('platformer')">
                    <div class="game-icon">üéÆ</div>
                    <div class="game-title">AVENTURA</div>
                    <div class="game-desc">Salta y esquiva obst√°culos</div>
                    <div class="game-highscore" id="platformer-highscore">RECORD: 0</div>
                </div>

                <div class="game-card" onclick="selectGame('sonic')">
                    <div class="game-icon">ü¶î</div>
                    <div class="game-title">SONIC</div>
                    <div class="game-desc">Corre, salta, rueda y recoge anillos</div>
                    <div class="game-highscore" id="sonic-highscore">RECORD: 0</div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showRankingScreen()">RANKINGS</button>
                <button class="btn btn-secondary" onclick="showCharacterScreen()">PERSONAJE</button>
                <button class="btn btn-danger" onclick="logout()">SALIR</button>
            </div>
        </div>

        <div id="gameScreen">
            <div class="game-header">
                <div>P1: <span id="playerName"></span></div>
                <div id="gameTitle">JUEGO</div>
                <div>SCORE: <span id="score">0</span></div>
                <div id="timerDisplay" style="display: none;">TIME: <span id="timer">60</span>S</div>
            </div>
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div class="game-controls">
                <button class="btn btn-secondary" id="startGameBtn" onclick="startGame()">START</button>
                <button class="btn btn-primary" onclick="backToMenu()">MENU</button>
            </div>
            <div id="mobileControls" class="mobile-controls" style="display: none;">
                <button class="btn" id="leftBtn">‚óÄ</button>
                <button class="btn" id="rightBtn">‚ñ∂</button>
                <button class="btn" id="upBtn">‚ñ≤</button>
                <button class="btn" id="rollBtn">‚≠ï</button>
            </div>
        </div>

        <div id="gameOverScreen">
            <h2>GAME OVER</h2>
            <div>SCORE FINAL:</div>
            <div id="finalScore">0</div>
            <div id="highScoreMessage" style="color: #00ff00; font-size: 18px; margin: 10px 0;"></div>
            
            <button class="btn btn-primary" onclick="playAgain()" style="width: 100%; margin-top: 20px;">REINICIAR</button>
            <button class="btn btn-secondary" onclick="backToMenuFromGameOver()" style="width: 100%;">MENU</button>
        </div>

        <div id="rankingScreen">
            <div class="ranking-container">
                <h2 style="color: #00ff00; margin-bottom: 20px; text-shadow: 2px 2px #003300;">RANKINGS GLOBALES</h2>
                
                <div class="ranking-tabs">
                    <button class="ranking-tab active" onclick="switchRanking('racing')">CARRERA</button>
                    <button class="ranking-tab" onclick="switchRanking('aliens')">ALIENS</button>
                    <button class="ranking-tab" onclick="switchRanking('platformer')">AVENTURA</button>
                    <button class="ranking-tab" onclick="switchRanking('sonic')">SONIC</button>
                </div>

                <div class="ranking-list" id="rankingList"></div>

                <button class="btn btn-primary" onclick="backToMenu()" style="width: 100%; margin-top: 20px;">VOLVER</button>
            </div>
        </div>

        <div id="characterScreen">
            <div class="character-editor">
                <h2 style="color: #00ff00; margin-bottom: 20px; text-shadow: 2px 2px #003300;">PERSONALIZAR</h2>
                
                <canvas id="characterPreview" width="200" height="300" style="border: 3px solid #00ff00; display: block; margin: 0 auto; background: #000;"></canvas>

                <div class="character-options">
                    <div class="option-group">
                        <h3>CAMISA</h3>
                        <input type="color" class="color-picker" id="shirtColor" value="#ff0000" onchange="updateCharacter()">
                    </div>
                    <div class="option-group">
                        <h3>PANTALON</h3>
                        <input type="color" class="color-picker" id="pantsColor" value="#0000ff" onchange="updateCharacter()">
                    </div>
                    <div class="option-group">
                        <h3>ZAPATOS</h3>
                        <input type="color" class="color-picker" id="shoesColor" value="#8b4513" onchange="updateCharacter()">
                    </div>
                    <div class="option-group">
                        <h3>GORRA</h3>
                        <select id="hatStyle" onchange="updateCharacter()">
                            <option value="none">NINGUNA</option>
                            <option value="cap">GORRA</option>
                            <option value="mario">MARIO</option>
                        </select>
                        <input type="color" class="color-picker" id="hatColor" value="#ff0000" onchange="updateCharacter()">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveCharacter()" style="width: 100%; margin-top: 20px;">GUARDAR</button>
                <button class="btn btn-secondary" onclick="backToMenu()" style="width: 100%;">VOLVER</button>
            </div>
        </div>

        <div class="loading hidden" id="loading" style="color: #00ff00;">CARGANDO...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, where, setDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTn_VTTMznvVJIZSjKhGOkvSOQQthNSfk",
            authDomain: "no-choques.firebaseapp.com",
            projectId: "no-choques",
            storageBucket: "no-choques.firebasestorage.app",
            messagingSenderId: "222726589609",
            appId: "1:222726589609:web:59e6dd00f28be661b0edb8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUsername = null;
        let currentGame = null;
        let gameRunning = false;
        let score = 0;
        let gameLoop;
        let userHighScores = { racing: 0, aliens: 0, platformer: 0, sonic: 0 };
        let characterCustomization = {
            shirtColor: '#ff0000',
            pantsColor: '#0000ff',
            shoesColor: '#8b4513',
            hatStyle: 'none',
            hatColor: '#ff0000'
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        // Dibujar alien pixel art
        function drawPixelAlien(x, y, size = 40) {
            const pixels = [
                [0,0,1,1,1,1,1,1,1,1,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,0],
                [1,1,0,1,1,1,1,1,1,0,1,1],
                [1,1,0,1,1,1,1,1,1,0,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,0,0,0,0,0,0,1,1,1],
                [1,1,1,0,0,0,0,0,0,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [0,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,1,1,1,1,1,1,1,1,0,0]
            ];
            
            const pixelSize = size / 12;
            pixels.forEach((row, i) => {
                row.forEach((pixel, j) => {
                    if (pixel === 1) {
                        ctx.fillStyle = '#00ff00';
                        ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                        
                        // Sombra para darle profundidad
                        if (i < pixels.length - 1 && j < row.length - 1) {
                            if (pixels[i + 1][j] === 0 || pixels[i][j + 1] === 0) {
                                ctx.fillStyle = '#00aa00';
                                ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                            }
                        }
                    } else if (pixel === 0 && i >= 2 && i <= 3 && j >= 2 && j <= 3) {
                        // Ojos negros
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                    } else if (pixel === 0 && i >= 2 && i <= 3 && j >= 8 && j <= 9) {
                        // Ojos negros
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                    }
                });
            });
        }

        // Dibujar carro pixel art
        function drawPixelCar(x, y, color = '#ff0000', isPlayer = false) {
            const w = 30, h = 50;
            
            // Cuerpo
            ctx.fillStyle = color;
            ctx.fillRect(x + 8, y, 14, 40);
            ctx.fillRect(x + 5, y + 10, 20, 30);
            
            // Ventanas
            ctx.fillStyle = isPlayer ? '#00ffff' : '#4a90e2';
            ctx.fillRect(x + 10, y + 5, 10, 8);
            ctx.fillRect(x + 10, y + 27, 10, 8);
            
            // Ruedas
            ctx.fillStyle = '#000';
            ctx.fillRect(x, y + 8, 5, 8);
            ctx.fillRect(x + 25, y + 8, 5, 8);
            ctx.fillRect(x, y + 34, 5, 8);
            ctx.fillRect(x + 25, y + 34, 5, 8);
            
            // Luces
            if (isPlayer) {
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(x + 8, y + 42, 4, 3);
                ctx.fillRect(x + 18, y + 42, 4, 3);
            }
        }

        // Crear fondo pixelado de carretera
        function drawPixelRoad() {
            // C√©sped
            for (let i = 0; i < canvas.height; i += 10) {
                for (let j = 0; j < canvas.width; j += 10) {
                    ctx.fillStyle = (Math.random() > 0.5) ? '#228B22' : '#006400';
                    ctx.fillRect(j, i, 10, 10);
                }
            }
            // Carretera
            ctx.fillStyle = '#808080';
            ctx.fillRect(0, canvas.height / 2 - 50, canvas.width, 100);
            // L√≠neas de carretera
            ctx.fillStyle = '#FFFF00';
            for (let k = 0; k < canvas.width; k += 40) {
                ctx.fillRect(k, canvas.height / 2 - 2, 20, 4);
            }
        }

        // Nuevas funciones para el juego Sonic-like (super detallado)

        // Pixel art para Sonic - Frames de animaci√≥n (running, jumping, rolling)
        const sonicRunningFrames = [
            // Frame 1 (standing/running pose 1)
            [
                [0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0],
                [0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],
                [0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0],
                [0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0],
                [0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0],
                [0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0]
            ],
            // Frame 2 (running pose 2) - Variaci√≥n detallada
            [
                [0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0],
                [0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0],
                [0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0],
                [0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
                [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
                [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
                [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
                [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0]
            ],
            // A√±ade m√°s frames para animaci√≥n detallada (4 frames total)
            // Frame 3
            [
                [0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],
                [0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0],
                [0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0],
                [0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0],
                [0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0]
            ],
            // Frame 4
            [
                [0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0],
                [0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
                [0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],
                [1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
                [0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1],
                [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0],
                [0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0],
                [0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0]
            ]
        ];

        const sonicJumpFrame = [
            // Frame de salto detallado
            [0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],
            [0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0],
            [0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0],
            [0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0],
            [0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0],
            [0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0]
        ];

        const sonicRollFrames = [
            // Frame 1 de rodar (bola detallada)
            [0,0,0,1,1,1,1,1,1,1,1,0,0,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,0,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,0,0],
            [0,0,0,1,1,1,1,1,1,1,1,0,0,0]
        ],
            // Frame 2 (rotaci√≥n)
            [
                [0,0,1,1,1,1,1,1,1,1,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,0],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [0,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,1,1,1,1,1,1,1,1,0,0]
            ]
        ];

        // Funci√≥n para dibujar Sonic con animaci√≥n detallada
        function drawPixelSonic(x, y, state, frame, size = 32) {
            let pixels;
            if (state === 'running') {
                pixels = sonicRunningFrames[frame % sonicRunningFrames.length];
            } else if (state === 'jumping') {
                pixels = sonicJumpFrame;
            } else if (state === 'rolling') {
                pixels = sonicRollFrames[frame % sonicRollFrames.length];
            } else {
                pixels = sonicRunningFrames[0]; // Idle
            }

            const pixelSize = size / pixels.length;
            pixels.forEach((row, i) => {
                row.forEach((pixel, j) => {
                    if (pixel === 1) {
                        ctx.fillStyle = '#0000FF'; // Azul de Sonic
                        ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                        // Detalles: ojos, espinas, etc.
                        if (i < 4 && j > 4 && j < 10) { // Espinas
                            ctx.fillStyle = '#0000AA';
                            ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                        }
                        if (i === 2 && j === 6) { // Ojo
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                        }
                    }
                });
            });
        }

        // Pixel art para anillo (detallado)
        function drawPixelRing(x, y, size = 20) {
            const pixels = [
                [0,0,1,1,1,1,0,0],
                [0,1,1,1,1,1,1,0],
                [1,1,1,1,1,1,1,1],
                [1,1,1,0,0,1,1,1],
                [1,1,1,0,0,1,1,1],
                [1,1,1,1,1,1,1,1],
                [0,1,1,1,1,1,1,0],
                [0,0,1,1,1,1,0,0]
            ];

            const pixelSize = size / 8;
            pixels.forEach((row, i) => {
                row.forEach((pixel, j) => {
                    if (pixel === 1) {
                        ctx.fillStyle = '#FFD700'; // Oro
                        ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                        // Brillo
                        if (i < 2 || j < 2) {
                            ctx.fillStyle = '#FFFF00';
                            ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize / 2, pixelSize / 2);
                        }
                    }
                });
            });
        }

        // Pixel art para enemigo (badnik simple, como Motobug)
        function drawPixelEnemy(x, y, size = 32) {
            const pixels = [
                [0,0,0,1,1,1,1,0,0,0],
                [0,0,1,1,1,1,1,1,0,0],
                [0,1,1,1,1,1,1,1,1,0],
                [1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1],
                [0,1,1,1,1,1,1,1,1,0],
                [0,0,1,1,1,1,1,1,0,0],
                [0,0,0,1,1,1,1,0,0,0],
                [0,0,1,1,0,0,1,1,0,0]
            ];

            const pixelSize = size / 10;
            pixels.forEach((row, i) => {
                row.forEach((pixel, j) => {
                    if (pixel === 1) {
                        ctx.fillStyle = '#FF0000'; // Rojo
                        ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                        // Detalles: ruedas
                        if (i === 9) {
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(x + j * pixelSize, y + i * pixelSize, pixelSize, pixelSize);
                        }
                    }
                });
            });
        }

        // Fondo detallado para Sonic (Green Hill-like con parallax)
        let bgOffset = 0;
        function drawSonicBackground() {
            // Cielo
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height / 2);

            // Monta√±as lejanas (parallax lento)
            ctx.fillStyle = '#228B22';
            for (let i = 0; i < canvas.width / 100; i++) {
                ctx.beginPath();
                ctx.moveTo((i * 100) - bgOffset / 4, canvas.height / 2);
                ctx.lineTo((i * 100 + 50) - bgOffset / 4, canvas.height / 4);
                ctx.lineTo((i * 100 + 100) - bgOffset / 4, canvas.height / 2);
                ctx.fill();
            }

            // Suelo con checker pattern (detallado)
            ctx.fillStyle = '#8B4513';
            for (let y = canvas.height / 2; y < canvas.height; y += 20) {
                for (let x = 0; x < canvas.width; x += 20) {
                    ctx.fillStyle = ((x + y + bgOffset) % 40 === 0) ? '#8B4513' : '#A0522D';
                    ctx.fillRect(x - bgOffset % 20, y, 20, 20);
                }
            }

            // Palmas o √°rboles (detallado)
            ctx.fillStyle = '#006400';
            for (let t = 0; t < canvas.width / 200; t++) {
                // Tronco
                ctx.fillRect((t * 200) - bgOffset / 2, canvas.height / 2 + 50, 20, 100);
                // Hojas
                ctx.beginPath();
                ctx.arc((t * 200 + 10) - bgOffset / 2, canvas.height / 2 + 50, 30, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Variables para Sonic game (detallado con f√≠sica, colisiones, generaci√≥n procedural)
        let player = { x: 100, y: 400, vx: 0, vy: 0, acc: 0.8, maxSpeed: 8, friction: 0.92, jump: -18, gravity: 0.9, isRolling: false, isJumping: false, animationFrame: 0, direction: 1, rings: 0 };
        let keys = {};
        let platforms = [];
        let rings = [];
        let enemies = [];
        let cameraX = 0;
        let levelLength = 0;
        let isOnGround = true;

        // Inicializar Sonic game
        function initSonic() {
            player.x = 100;
            player.y = canvas.height - 100;
            player.vx = 0;
            player.vy = 0;
            player.isRolling = false;
            player.isJumping = false;
            player.animationFrame = 0;
            player.rings = 0;
            player.direction = 1;
            score = 0;
            bgOffset = 0;
            cameraX = 0;
            levelLength = 0;
            platforms = [{ x: 0, y: canvas.height - 50, w: canvas.width * 10, h: 50 }]; // Suelo inicial
            rings = [];
            enemies = [];
            generateLevel();
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('mobileControls').style.display = 'flex';
            setupControls();
        }

        // Generaci√≥n procedural de nivel (detallado: plataformas, rings, enemies)
        function generateLevel() {
            for (let i = levelLength; i < levelLength + 2000; i += 200) {
                // Plataformas flotantes aleatorias
                if (Math.random() > 0.5) {
                    platforms.push({ x: i + Math.random() * 100, y: canvas.height - 150 - Math.random() * 100, w: 100 + Math.random() * 200, h: 20 });
                }
                // Rings
                for (let r = 0; r < 5; r++) {
                    rings.push({ x: i + r * 20, y: canvas.height - 100 - Math.sin(r) * 20, collected: false });
                }
                // Enemigos
                if (Math.random() > 0.7) {
                    enemies.push({ x: i + 100, y: canvas.height - 82, vx: -2 + Math.random() * -1, size: 32, alive: true });
                }
            }
            levelLength += 2000;
        }

        // Actualizar Sonic (f√≠sica detallada con momentum, colisiones)
        function updateSonic() {
            player.animationFrame += 0.2;

            // Input
            if (keys['ArrowLeft']) {
                player.vx -= player.acc;
                player.direction = -1;
            }
            if (keys['ArrowRight']) {
                player.vx += player.acc;
                player.direction = 1;
            }
            if (keys['ArrowUp'] && isOnGround) {
                player.vy = player.jump;
                player.isJumping = true;
                isOnGround = false;
            }
            if (keys['ArrowDown']) {
                player.isRolling = true;
            } else {
                player.isRolling = false;
            }

            // F√≠sica
            player.vx = Math.max(-player.maxSpeed, Math.min(player.maxSpeed, player.vx));
            if (!keys['ArrowLeft'] && !keys['ArrowRight']) {
                player.vx *= player.friction;
            }
            player.x += player.vx;
            player.y += player.vy;
            if (!isOnGround) {
                player.vy += player.gravity;
            }

            // Colisiones con plataformas
            isOnGround = false;
            platforms.forEach(plat => {
                if (player.x + 16 > plat.x && player.x < plat.x + plat.w && player.y + 32 > plat.y && player.y + player.vy < plat.y && player.vy >= 0) {
                    player.y = plat.y - 32;
                    player.vy = 0;
                    isOnGround = true;
                    player.isJumping = false;
                }
            });

            // Colisiones con rings (detallado)
            rings.forEach(ring => {
                if (!ring.collected && Math.abs(player.x - ring.x) < 20 && Math.abs(player.y - ring.y) < 20) {
                    ring.collected = true;
                    score += 10;
                    player.rings += 1;
                    updateScore();
                }
            });

            // Colisiones con enemigos
            enemies.forEach(enemy => {
                if (enemy.alive && Math.abs(player.x - enemy.x) < 20 && Math.abs(player.y - enemy.y) < 20) {
                    if (player.isRolling || player.vy > 0) {
                        enemy.alive = false;
                        score += 50;
                        player.vy = player.jump / 2; // Rebote
                    } else {
                        // Perder rings o game over
                        if (player.rings > 0) {
                            player.rings = Math.max(0, player.rings - 10);
                        } else {
                            endGame();
                        }
                    }
                }
                // Movimiento enemigo
                enemy.x += enemy.vx;
            });

            // C√°mara scrolling (detallado)
            if (player.x > canvas.width / 2 + cameraX) {
                cameraX = player.x - canvas.width / 2;
            }
            bgOffset += Math.abs(player.vx) / 2;

            // Generar m√°s nivel si necesario
            if (player.x > levelLength - canvas.width) {
                generateLevel();
            }

            // Ca√≠da game over
            if (player.y > canvas.height) {
                endGame();
            }

            // Score basado en distancia + rings
            score += Math.floor(Math.abs(player.vx) / 5);
            updateScore();
        }

        // Dibujar Sonic game (detallado)
        function drawSonic() {
            drawSonicBackground();

            // Dibujar plataformas
            ctx.fillStyle = '#556B2F';
            platforms.forEach(plat => {
                ctx.fillRect(plat.x - cameraX, plat.y, plat.w, plat.h);
                // Detalle: textura
                for (let tx = 0; tx < plat.w; tx += 10) {
                    ctx.fillStyle = '#6B8E23';
                    ctx.fillRect(plat.x - cameraX + tx, plat.y, 5, plat.h);
                }
            });

            // Dibujar rings
            rings.forEach(ring => {
                if (!ring.collected) {
                    drawPixelRing(ring.x - cameraX, ring.y);
                }
            });

            // Dibujar enemigos
            enemies.forEach(enemy => {
                if (enemy.alive) {
                    drawPixelEnemy(enemy.x - cameraX, enemy.y);
                }
            });

            // Dibujar player
            let state = 'running';
            if (player.isJumping || !isOnGround) state = 'jumping';
            if (player.isRolling) state = 'rolling';
            drawPixelSonic(player.x - cameraX, player.y, state, Math.floor(player.animationFrame));

            // HUD rings
            ctx.fillStyle = '#FFFFFF';
            ctx.font = '20px Courier New';
            ctx.fillText(`RINGS: ${player.rings}`, 20, 50);
        }

        // Configurar controles (teclado y mobile buttons)
        function setupControls() {
            window.addEventListener('keydown', e => keys[e.key] = true);
            window.addEventListener('keyup', e => keys[e.key] = false);

            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const upBtn = document.getElementById('upBtn');
            const rollBtn = document.getElementById('rollBtn');

            leftBtn.addEventListener('touchstart', () => keys['ArrowLeft'] = true);
            leftBtn.addEventListener('touchend', () => keys['ArrowLeft'] = false);
            rightBtn.addEventListener('touchstart', () => keys['ArrowRight'] = true);
            rightBtn.addEventListener('touchend', () => keys['ArrowRight'] = false);
            upBtn.addEventListener('touchstart', () => keys['ArrowUp'] = true);
            upBtn.addEventListener('touchend', () => keys['ArrowUp'] = false);
            rollBtn.addEventListener('touchstart', () => keys['ArrowDown'] = true);
            rollBtn.addEventListener('touchend', () => keys['ArrowDown'] = false);
        }

        // Funciones generales (asumiendo el resto del c√≥digo original, agregando handles para sonic)

        function selectGame(game) {
            currentGame = game;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('rankingScreen').style.display = 'none';
            document.getElementById('characterScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gameTitle').innerText = game.toUpperCase();
            document.getElementById('playerName').innerText = currentUsername;
            document.getElementById('startGameBtn').style.display = 'block';
            if (game === 'sonic') {
                document.getElementById('mobileControls').style.display = 'flex';
            } else {
                document.getElementById('mobileControls').style.display = 'none';
            }
        }

        function startGame() {
            if (gameRunning) return;
            gameRunning = true;
            score = 0;
            updateScore();
            document.getElementById('startGameBtn').style.display = 'none';
            if (currentGame === 'sonic') {
                initSonic();
            } // A√±ade init para otros juegos si es necesario
            gameLoop = requestAnimationFrame(gameUpdate);
        }

        function gameUpdate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (currentGame === 'sonic') {
                updateSonic();
                drawSonic();
            } // A√±ade updates para otros juegos
            if (gameRunning) {
                requestAnimationFrame(gameUpdate);
            }
        }

        function updateScore() {
            document.getElementById('score').innerText = score;
        }

        function endGame() {
            gameRunning = false;
            cancelAnimationFrame(gameLoop);
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            document.getElementById('finalScore').innerText = score;
            // Update highscore, etc. (asumir l√≥gica original)
            if (score > userHighScores[currentGame]) {
                userHighScores[currentGame] = score;
                document.getElementById('highScoreMessage').innerText = 'NUEVO RECORD!';
                // Update Firebase
                updateDoc(doc(db, 'users', currentUser.uid), {
                    [`highScores.${currentGame}`]: score
                });
            } else {
                document.getElementById('highScoreMessage').innerText = '';
            }
        }

        function playAgain() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            startGame();
        }

        function backToMenuFromGameOver() {
            document.getElementById('gameOverScreen').style.display = 'none';
            backToMenu();
        }

        function backToMenu() {
            if (gameRunning) {
                gameRunning = false;
                cancelAnimationFrame(gameLoop);
            }
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('menuScreen').style.display = 'block';
            document.getElementById('rankingScreen').style.display = 'none';
            document.getElementById('characterScreen').style.display = 'none';
            document.getElementById('mobileControls').style.display = 'none';
            // Update highscores in menu
            document.getElementById('sonic-highscore').innerText = `RECORD: ${userHighScores.sonic}`;
        }

        // Asumir el resto de funciones como login, register, rankings, etc. permanecen iguales, agregando 'sonic' donde sea necesario (e.g., en switchRanking, getRankings)

        function switchRanking(game) {
            // ... (c√≥digo original)
            currentGame = game; // Para rankings
            getRankings(game);
        }

        async function getRankings(game) {
            const q = query(collection(db, 'users'), orderBy(`highScores.${game}`, 'desc'), limit(10));
            const querySnapshot = await getDocs(q);
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            let pos = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const item = document.createElement('div');
                item.classList.add('ranking-item');
                if (pos === 1) item.classList.add('top-1');
                if (pos === 2) item.classList.add('top-2');
                if (pos === 3) item.classList.add('top-3');
                item.innerHTML = `
                    <span class="rank-pos">${pos}</span>
                    <span class="rank-name">${data.username}</span>
                    <span class="rank-score">${data.highScores[game] || 0}</span>
                `;
                rankingList.appendChild(item);
                pos++;
            });
        }

        // Inicializaci√≥n (onAuthStateChanged, etc.) - asumiendo c√≥digo original completo

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                getUserData();
            } else {
                showScreen('loginScreen');
            }
        });

        async function getUserData() {
            const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                currentUsername = data.username;
                userHighScores = data.highScores || { racing: 0, aliens: 0, platformer: 0, sonic: 0 };
                characterCustomization = data.character || characterCustomization;
                document.getElementById('menuUsername').innerText = currentUsername;
                document.getElementById('racing-highscore').innerText = `RECORD: ${userHighScores.racing}`;
                document.getElementById('aliens-highscore').innerText = `RECORD: ${userHighScores.aliens}`;
                document.getElementById('platformer-highscore').innerText = `RECORD: ${userHighScores.platformer}`;
                document.getElementById('sonic-highscore').innerText = `RECORD: ${userHighScores.sonic}`;
                showScreen('menuScreen');
                updateCharacter();
            }
        }

        // Otras funciones como login, register, logout, showRankingScreen, showCharacterScreen, updateCharacter, saveCharacter - asumiendo permanecen iguales

        function showScreen(screenId) {
            const screens = ['loginScreen', 'menuScreen', 'gameScreen', 'gameOverScreen', 'rankingScreen', 'characterScreen'];
            screens.forEach(id => document.getElementById(id).style.display = id === screenId ? 'block' : 'none');
        }

        // A√±ade implementaciones para otros juegos si es necesario, pero como el original est√° truncado, enfocamos en sonic

        // -------------------------------------------------
        //  LOGIN / REGISTER
        // -------------------------------------------------
        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                showError('Completa usuario y contrase√±a');
                return;
            }

            showLoading(true);
            clearError();

            try {
                // Firebase Auth usa email, as√≠ que convertimos el username ‚Üí email
                const email = `${username.toLowerCase()}@minijuegos.com`;

                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargar√° de mostrar el men√∫
            } catch (err) {
                let msg = 'Error al iniciar sesi√≥n';
                if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                    msg = 'Usuario o contrase√±a incorrectos';
                } else if (err.code === 'auth/invalid-email') {
                    msg = 'Usuario no v√°lido';
                }
                showError(msg);
            } finally {
                showLoading(false);
            }
        }

        async function register() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                showError('Completa usuario y contrase√±a');
                return;
            }
            if (password.length < 6) {
                showError('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            showLoading(true);
            clearError();

            try {
                const email = `${username.toLowerCase()}@minijuegos.com`;

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Guardamos el nombre de usuario y high‚Äëscores iniciales
                await setDoc(doc(db, 'users', user.uid), {
                    username: username,
                    highScores: { racing: 0, aliens: 0, platformer: 0, sonic: 0 },
                    character: characterCustomization
                });

                // onAuthStateChanged mostrar√° el men√∫ autom√°ticamente
            } catch (err) {
                let msg = 'Error al crear la cuenta';
                if (err.code === 'auth/email-already-in-use') {
                    msg = 'Ese usuario ya est√° registrado';
                } else if (err.code === 'auth/weak-password') {
                    msg = 'Contrase√±a demasiado d√©bil';
                }
                showError(msg);
            } finally {
                showLoading(false);
            }
        }

        // -------------------------------------------------
        //  HELPERS UI
        // -------------------------------------------------
        function showError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.style.display = 'block';
        }
        function clearError() {
            const el = document.getElementById('loginError');
            el.textContent = '';
            el.style.display = 'none';
        }
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            const btns = document.querySelectorAll('#loginScreen .btn');
            btns.forEach(b => b.disabled = show);
        }

        // -------------------------------------------------
        //  ENTER ‚Üí LOGIN
        // -------------------------------------------------
        document.getElementById('usernameInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });
        document.getElementById('passwordInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });

        // -------------------------------------------------
        //  AUTH OBSERVER (el que ya ten√≠as)
        // -------------------------------------------------
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await getUserData();          // <-- carga username, high‚Äëscores, etc.
                showScreen('menuScreen');
            } else {
                showScreen('loginScreen');
            }
        });

        // -------------------------------------------------
        //  FUNCI√ìN PARA MOSTRAR PANTALLAS
        // -------------------------------------------------
        function showScreen(screenId) {
            const screens = ['loginScreen', 'menuScreen', 'gameScreen',
                             'gameOverScreen', 'rankingScreen', 'characterScreen'];
            screens.forEach(id => {
                document.getElementById(id).style.display = (id === screenId) ? 'block' : 'none';
            });
        }

        function showRankingScreen() {
            showScreen('rankingScreen');
            switchRanking('racing'); // Por defecto
        }

        function showCharacterScreen() {
            showScreen('characterScreen');
            // Cargar personalizaci√≥n actual
            document.getElementById('shirtColor').value = characterCustomization.shirtColor;
            document.getElementById('pantsColor').value = characterCustomization.pantsColor;
            document.getElementById('shoesColor').value = characterCustomization.shoesColor;
            document.getElementById('hatStyle').value = characterCustomization.hatStyle;
            document.getElementById('hatColor').value = characterCustomization.hatColor;
            updateCharacter();
        }

        async function logout() {
            await signOut(auth);
            // onAuthStateChanged manejar√° el cambio a login
        }

        function updateCharacter() {
            const previewCanvas = document.getElementById('characterPreview');
            const previewCtx = previewCanvas.getContext('2d');
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

            // Dibujar personaje simple (ejemplo)
            // Cuerpo
            previewCtx.fillStyle = document.getElementById('shirtColor').value;
            previewCtx.fillRect(80, 100, 40, 60);

            // Pantalones
            previewCtx.fillStyle = document.getElementById('pantsColor').value;
            previewCtx.fillRect(80, 160, 40, 60);

            // Zapatos
            previewCtx.fillStyle = document.getElementById('shoesColor').value;
            previewCtx.fillRect(80, 220, 40, 20);

            // Gorra
            const hatStyle = document.getElementById('hatStyle').value;
            if (hatStyle !== 'none') {
                previewCtx.fillStyle = document.getElementById('hatColor').value;
                if (hatStyle === 'cap') {
                    previewCtx.fillRect(70, 80, 60, 20);
                } else if (hatStyle === 'mario') {
                    previewCtx.fillRect(75, 70, 50, 30);
                }
            }
        }

        async function saveCharacter() {
            characterCustomization = {
                shirtColor: document.getElementById('shirtColor').value,
                pantsColor: document.getElementById('pantsColor').value,
                shoesColor: document.getElementById('shoesColor').value,
                hatStyle: document.getElementById('hatStyle').value,
                hatColor: document.getElementById('hatColor').value
            };
            await updateDoc(doc(db, 'users', currentUser.uid), {
                character: characterCustomization
            });
            backToMenu();
        }

        // Inicializar
        updateCharacter(); // Por si acaso
    </script>
</body>
</html>
